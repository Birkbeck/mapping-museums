---
title: "Mapping Museums, Andrea Ballatore"
output:
  html_document:
    self_contained: no
  pdf_document: default
---

<style>
pre:not([class]) {
    color: white;
    background-color: #272822;
}
</style>

# Setup

```{r setup, echo=FALSE, message=FALSE}
source("mm_setup.R")

all_years = seq(1960,2022)
summary(all_years)
```

# Sandbox

```{r, eval=FALSE}
print(get_open_museums_by_year(2016, museums_bg@data, 'all', 'all'))
print(get_open_museums_by_year(2022, museums_bg@data, 'all', 'all'))
unique(FUN_get_open_at_given_time(museums_bg@data, 2023))
```

# Load data

## Load museum dataset

```{r load_museums, echo=FALSE, message=FALSE, eval=T}
# Preparation
db_source_fn = "museums-2022_06_27.csv"
db_fn = paste0("../datasets/museums/input/maindata/",db_source_fn)
#headers = read.csv(db_fn, skip = 0, header = F, nrows = 1, as.is = T)
full_df = read.csv(db_fn)
#colnames(full_df)=headers
#rm(headers)

# ROWS
nrow(full_df)
stopifnot(is_unique(full_df$museum_id))
n = nrow(full_df)
#stopifnot(n==3954)

# COLUMNS
full_df$`NA` = NULL # remove empty col
ncol(full_df)
stopifnot( ncol(full_df) == 35 )

# normalise column names
names(full_df) = trimws( tolower( names(full_df) ) )
names(full_df) = gsub(" ", "_", names(full_df))
#names(full_df) = gsub("\\)", "", names(full_df))
#names(full_df) = gsub("\\(", "", names(full_df))

names(full_df)

# ID should be unique
# Remove Duplicated ID: mm.misc.195
#stopifnot( !any(duplicated(full_df$project_id)) )
#full_df = full_df[!rownames(full_df) %in% c("3954"), ]
#stopifnot(nrow(full_df)==3983)

rownames(full_df) = full_df$project_id
stopifnot( !any(duplicated(full_df$project_id)) )

# strip all new lines in the df
full_df <- data.frame(lapply(full_df, function(x) {gsub("\n", "  ", x)}))
full_df <- data.frame(lapply(full_df, function(x) {gsub("\t", "  ", x)}))

# fix size column (v10+)
full_df$size = as.character(full_df$size)
summary(full_df$size)
full_df$size[full_df$size=='unknown']='unknown_sz'
full_df$size[is.na(full_df$size)]='unknown_sz'

# columns as factors
fcols <- c(
           "town_or_city",
           "postcode",
           "year_opened",
           "year_closed",
           "subject_matter",
           "accreditation",
           "governance",
           "size")
full_df[fcols] <- lapply(full_df[fcols], trimws)
full_df[fcols] <- lapply(full_df[fcols], factor)
rm(fcols)

# ------------------------------------------------
# CLEAN MUSEUM SIZES (AIM/ACE)
# ------------------------------------------------
clean_sizes <- function( sz ){
  # normalise column names
  sz = tolower( gsub(" ", "_", sz) )
  sz = gsub("\\)", "", sz)
  sz = gsub("\\.", "", sz)
  sz = gsub(",", "", sz)
  sz = gsub("_-_", "-", sz)
  sz = gsub("\\(", "", sz)
  sz = trimws(sz)
  return(sz)
}

# fix lat/lon
full_df$latitude  = as.numeric(as.character(full_df$latitude)) # important
full_df$longitude = as.numeric(as.character(full_df$longitude))  # important

View(full_df)

# ------------------------------------------------
# prep OPENINGS and CLOSINGS YEARS
# ------------------------------------------------

# INCORRECT LOGIC
get_decade <- function(x){
  x = paste0(substr(as.character(x),0,3),"0")
  #n = length(x)
  #print(n)
  #x[x="NA0"]=NA
  #x = replace(x, x=="NA0", NA)
  #x = replace(x, x=="9990", NA)
  #x = replace(x, x=="5550", NA)
  #print(length(x))
  #stopifnot(length(x),n)
  #return(x)
  return(as.factor(x))
}

# INCORRECT LOGIC
remove_uncertain_decades <- function(decades, probs){
  threshold = 1/10 # threshold of 10 years
  dec = as.character(decades)
  dec[ probs < threshold ] = NA
  #print(dec)
  return(as.factor(dec))
}

# format of years: 1950;2022, extract data
summary(full_df$year_opened)
print_count_NAs(full_df$year_opened)
print_count_NAs(full_df$year_closed)
full_df$year_opened_BEG = as.numeric(unlist(strsplit(as.character(full_df$year_opened), ":"))[c(T, F)])
full_df$year_opened_END = as.numeric(unlist(strsplit(as.character(full_df$year_opened), ":"))[c(F, T)])
full_df$year_opened_MEAN = round((full_df$year_opened_BEG+full_df$year_opened_END)/2,0)
summary(full_df$year_opened_MEAN)
#full_df$year_opened_LEN = (full_df$year_opened_END - full_df$year_opened_BEG) + 1
#full_df$year_opened_PROB = (full_df$year_opened_END - full_df$year_opened_BEG)
#full_df$year_opened_PROB = ifelse( full_df$year_opened_PROB == 0, 1, round(1/full_df$year_opened_PROB,3))
#summary(full_df$year_opened_LEN)

summary(full_df$year_closed)

# extract data
full_df$year_closed_BEG = as.numeric(unlist(strsplit(as.character(full_df$year_closed), ":"))[c(T, F)])
full_df$year_closed_END = as.numeric(unlist(strsplit(as.character(full_df$year_closed), ":"))[c(F, T)])

full_df$year_closed_BEG[ full_df$year_closed_BEG==9999 ] <- NA
full_df$year_closed_END[ full_df$year_closed_END==9999 ] <- NA
full_df$year_closed_BEG[ full_df$year_closed_BEG==1111 ] <- NA
full_df$year_closed_END[ full_df$year_closed_END==1111 ] <- NA

full_df$year_closed_MEAN = round((full_df$year_closed_BEG+full_df$year_closed_END)/2,0)
summary(full_df$year_closed_MEAN)
#full_df$year_closed_LEN = (full_df$year_closed_END - full_df$year_closed_BEG) + 1
#full_df$year_closed_PROB = (full_df$year_closed_END - full_df$year_closed_BEG)
#full_df$year_closed_PROB = ifelse( full_df$year_closed_PROB == 0, 1, round(1/full_df$year_closed_PROB,3))

# DECADE LOGIC - INCORRECT, skip
#full_df$decade_opened = get_decade( full_df$year_opened_MEAN )
#full_df$decade_closed = get_decade( full_df$year_closed_MEAN )
# remove decades for uncertain data
#full_df$decade_opened = remove_uncertain_decades(full_df$decade_opened, full_df$year_opened_PROB)
#full_df$decade_closed = remove_uncertain_decades(full_df$decade_closed, full_df$year_closed_PROB)

full_years = full_df[,c("year_opened","year_opened_BEG","year_opened_END",
                        "year_closed","year_closed_BEG","year_closed_END")]
summary(full_years)
View(full_years[sample(nrow(full_years),30), ])
rm(full_years)


# ------------------------------------------------
# Fix Governance category (Oct 2019)
# ------------------------------------------------
nat_museums_ids = c("mm.domus.SE511","mm.domus.SE573","mm.domus.WM038","mm.domus.SW118","mm.domus.SE350","mm.domus.SE453","mm.domus.SE351","mm.MDN.018","mm.ace.1153","mm.misc.092",'mm.misc.141')
length(nat_museums_ids)
#full_df[ full_df$project_id %in% nat_museums_ids, ]$governance = '/Government/National'
summary(full_df$governance)
rm(nat_museums_ids)
# ------------------------------------------------
full_df$project_id = full_df$museum_id

FUN_save_museum_dataset(full_df,'museums_full_df')

write(db_source_fn, '../plots/museums_spreadsheet_source.txt')

```

## Calc simplified fields

```{r simpl_fields}

# old size_categories = c("unknown","tiny","very_small","small","medium","large","very_large","huge")
size_categories = c("small","medium","large","huge","unknown_sz")
gov_types_simpl = c("government","independent","university","unknown_gov")

update_simplified_fields = function(full_df){
  print("update_simplified_fields")
  # get simplified governance for stats
  summary(full_df$governance)
  stopifnot( !FUN_col_exists(full_df,'size_simpl') )
  
  get_simplified_gov = function(g){
    if (length(grep("Government",g))>0) return("government")
    if (length(grep("Independent",g))>0) return("independent")
    if (length(grep("University",g))>0) return("university")
    if (length(grep("Unknown",g))>0) return("unknown_gov")
    stopifnot(FALSE) # should never call this
  }
  full_df$governance_simpl = as.factor(sapply(full_df$governance, get_simplified_gov))
  summary(full_df$governance_simpl)
  
  # get simplified size for stats
  summary(full_df$size)
  #size_categories = unique(as.character(mdf$mm_size))
  
  stopifnot(FUN_countNA(full_df$size)==0)
  full_df$size = factor(full_df$size, levels=c(size_categories), ordered=TRUE)
  # subject matter
  
  # fix
  #full_df$subject_matter[ full_df$subject_matter == "/Industry and manufactu/Metals" ] = "/Industry and manufacture/Metals"
  #full_df$subject_matter = as.factor(as.character(full_df$subject_matter))
  
  get_simplified_class18 = function(s){
    #print(s)
    high_level = strsplit(s,'-')[[1]][1]
    #print(high_level)
    if (!is.na(high_level) && nchar(high_level)>0){
      return( tolower(gsub(" ", "_", high_level)) )
    } else { return(NA) }
  }
  
  full_df$subject_matter_simpl = as.factor(sapply(as.character(full_df$subject_matter),
                                                      get_simplified_class18))
  
  # classes with < 100 museums
  print(summary(full_df$subject_matter_simpl))
  class18_small_types = as.data.frame(table(full_df$subject_matter_simpl))
  
  class18_small_types = as.character(class18_small_types[class18_small_types$Freq < 100, ]$Var1)
  
  
  get_simplified_class18_aggr = function(s){
    if (s %in% class18_small_types) return("SMALL_SUBJECTS")
    return(s)
  }
  full_df$subject_matter_simpl_aggr = as.factor(sapply(as.character(full_df$subject_matter_simpl),
                                                      get_simplified_class18_aggr))
  
  class18_simpl_aggr_types = as.character(unique(full_df$subject_matter_simpl_aggr))
  class18_simpl_aggr_types = class18_simpl_aggr_types[!is.na(class18_simpl_aggr_types)]
  
  #View(summary(full_df$subject_matter_simpl))
  names(summary(full_df$subject_matter_simpl))
  #View(summary(full_df$subject_matter_simpl_aggr))
  
  # special type
  #  - Small, independent museums 
  #  - National
  #  - Medium and large local authority museums
  full_df$special_type = as.factor(apply( full_df, 1, function(row){
    if (row['size'] == "small" & row['governance_simpl'] == "independent") return("sm_indep")
    if (row['governance'] == "/Government/National") return("national")
    if (row['size'] %in% c("medium","large") & row['governance']=="/Government/Local Authority")
      return("local_auth")
    return(NA)
  }))
  
  return(full_df)
}

```

## Load UK spatial datasets

```{r load_spatial_uk, eval=F}
# geo-utils

load_uk_dataset <- function( name ){
  ds = readRDS(paste0("../datasets/uk_datasets/", name))
  stopifnot( nrow(ds)>0 )
  print(paste("load_uk_dataset:",name))
  return(ds)
}

map_gss_type <- function( x ){
  # https://en.wikipedia.org/wiki/ONS_coding_system
  # E07 E06 E08 E09 S12 E10 W06 E12 E11 E13
  # replace NI codes
  x = gsub("(95)", "NIR", x)
  x = substr(x,0,3)
  y = as.factor( mapvalues(x, c("E07","E06", "E08","E09",
                                    "E10","W06", "E12","E11","S12",
                                    "W92","S92","N92","E92","NIR"),
    c("non_metro_district","unitary_authority","metro_borough","london_borough",
      "county","unitary_authority","english_region","metro_county","unitary_authority",
      "country","country","country","country", "ni_district")))

  return( y )
}

add_gss_codes <- function(df,gss_field){
  gsscodes = as.character(df[,gss_field])
  #print(length(gsscodes))
  #print(head(gsscodes))
  df$GSS3 = substr(gsscodes,0,3) # first 3 chars of GSS
  #sort(summary(df$GSS3),decreasing = T)
  df$GSS1 = as.factor(substr(gsscodes,0,1)) # first char of GSS
  df$GSS1 = as.factor( mapvalues( as.character(df$GSS1), c("9"), c("N")))
  #sort(summary(df$GSS1),decreasing = T)

  # map GSS types
  df$GSS_TYPE = map_gss_type(df$GSS3)
  df$GSS3 = as.factor(df$GSS3)
  #sort(summary(df$GSS_TYPE),decreasing = T)
  return(df)
}

# load Engl statistical regions
engl_stat_regions_full <- load_uk_dataset("eng_regions_2011-simp01.rds")
stopifnot( nrow(engl_stat_regions_full) == 9 )
names(engl_stat_regions_full)
#engl_stat_regions_full$rgn16cd
# drop columns
engl_stat_regions_2016 = engl_stat_regions_full # engl_stat_regions_full[,c("rgn16cd","rgn16nm")]
proj4string(engl_stat_regions_2016)
summary(engl_stat_regions_2016)
stopifnot( nrow(engl_stat_regions_2016) == 9 )

# load UK countries
uk_countries_2011 = load_uk_dataset("uk_countries_2011-simp01.rds")
proj4string(uk_countries_2011)
stopifnot( nrow(uk_countries_2011) == 4 )

uk_countries_2011_simp = load_uk_dataset("uk_countries_2011-simp05.rds")
stopifnot( nrow(uk_countries_2011_simp) == 4 )

# UK countries and English Regions (without England)
uk_countries_reg_2011 = load_uk_dataset("uk_countries_and_eng_regions_2011-simp001.rds")
stopifnot( nrow(uk_countries_reg_2011) == 12 )

uk_countries_reg_2011_simpl = load_uk_dataset("uk_countries_and_eng_regions_2011_presimpl-simp005.rds")
stopifnot( nrow(uk_countries_reg_2011_simpl) == 12 )

# load UK cities
uk_cities = load_uk_dataset("uk_cities_geon_1000.rds")
stopifnot(nrow(uk_cities)==4344)
names(uk_cities)

# load UK LADS 2016
uk_lads_2016 <- load_uk_dataset("uk_local_auth_2016-simp0005.rds")

get_cities_for_labels <- function( min_pop ){
  cities = subset(uk_cities,
                  (uk_cities$feature_code == 'PPLC' |
                    uk_cities$feature_code == 'PPLA2' |
                    uk_cities$feature_code == 'PPLA' ) &
                    uk_cities$population >= min_pop )
  stopifnot(nrow(cities)>0)
  return(cities)
}

# replace GSS codes with readable names
gss_codes = uk_countries_reg_2011@data[,c("GSS","NAME")]
gss_codes = unique(rbind(gss_codes,uk_countries_2011@data[,c("GSS","NAME")]))
gss_codes = unique(rbind(gss_codes,uk_lads_2016@data[,c("GSS","NAME")]))
gss_codes$GSS = trimws(gss_codes$GSS)

rm(uk_lads_2016)

```

## Build museum spatial dataset

From here on, museums_bg is the core dataset, and not full_df!

```{r spatialds, message=FALSE, eval=T}

summary(full_df$latitude)
print_count_NAs(full_df$latitude)
full_df = update_simplified_fields(full_df)

# remove museums without coords
sdf = full_df[ !is.na(full_df$latitude), ]

# remove museums with invalid coords and print them
wrong_coords = sdf[ sdf$latitude < 0.1,  ]
stopifnot(nrow(wrong_coords)==0)
#View(wrong_coords)
#wrong_coords[,c("project_id","longitude")]
rm(wrong_coords)

sdf = sdf[ sdf$latitude >= 0.1,  ]
sdf = sdf[ sdf$latitude <= 90,  ]

summary(as.numeric(sdf$latitude))
summary(as.numeric(sdf$longitude))

# museums with coords
#stopifnot( nrow(sdf) == ALL_MUSEUMS_N )

# build SpatialPointsDataFrame
coordinates(sdf) <- ~longitude+latitude
proj4string(sdf) <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")

# add country field
uk_countries_2011 = load_uk_dataset("uk_countries_2011-simp01.rds")
units_over <- over(spTransform(sdf, proj4string(uk_countries_2011)), uk_countries_2011[,c("GSS","NAME")])
colnames(units_over) = c("country_gss","country_name")
sdf = spCbind(sdf, units_over)
#sdf$country_name[is.na(sdf$country_name)]="OTHER"
sdf$country_name = as.factor(as.character(sdf$country_name))
rm(units_over)

# add English Region field
stopifnot(nrow(uk_countries_reg_2011)>0)
units_over <- over(spTransform(sdf, proj4string(uk_countries_reg_2011)), uk_countries_reg_2011[,c("GSS","NAME")])
colnames(units_over) = c("region_gss","region_name")
sdf = spCbind(sdf, units_over)
sdf$region_gss = as.factor(sdf$region_gss)
rm(units_over)

# add LAD field
uk_lad_2016 = load_uk_dataset("uk_local_auth_2016-full.rds")
units_over <- over(spTransform(sdf, proj4string(uk_lad_2016)), uk_lad_2016[,c("GSS","NAME")])
colnames(units_over) = c("lad16_gss","lad16_name")
sdf = spCbind(sdf, units_over)
sdf$lad16_gss = as.factor(sdf$lad16_gss)
rm(units_over)
rm(uk_lad_2016)

stopifnot(nrow(uk_countries_reg_2011)>0)
units_over <- over(spTransform(sdf, proj4string(uk_countries_reg_2011)), uk_countries_reg_2011[,c("GSS","NAME")])
colnames(units_over) = c("region_gss","region_name")
sdf = spCbind(sdf, units_over)
sdf$region_gss = as.factor(sdf$region_gss)
rm(units_over)

# transform data
museums_ll = sdf
museums_bg <- spTransform(museums_ll, british_grid_crs)
saveRDS(museums_bg,'../datasets/museums/museums_bg_sdf.rds')

# write GeoJSON
sdftmp = sdf
sdftmp$size = as.character(sdf$size)
writeOGR(sdftmp, "../datasets/museums/museums.geojson", layer="museums", driver="GeoJSON", 
         overwrite_layer = T)
rm(sdftmp)
rm(sdf)

# datasets: museums_ll and museums_bg
stopifnot(nrow(museums_ll)==ALL_MUSEUMS_N)
stopifnot(nrow(museums_bg)==ALL_MUSEUMS_N)

# fix
museums_bg$region_gss.1 = NULL
museums_bg$region_name.1 = NULL

FUN_gen_last_update_file('../datasets/museums/')

rm(museums_ll)
```

# Validate MM dataset

```{r}
check_mm_valid(museums_bg)
```


# Museum Analysis


On museums with spatial data (N = ALL_MUSEUMS_N)

## Load museum spatial data

```{r basic_plots, eval=T}

museums_bg = readRDS('../datasets/museums/museums_bg_sdf.rds')
museums_bg$project_id = museums_bg$museum_id

full_df = readRDS('../datasets/museums/museums_full_df.rds')
museums2022sdf = FUN_get_museums_open_in_a_year(museums_bg, 2022)
stopifnot(nrow(museums2022sdf)==3363)

class18_simpl_aggr_types = as.character(unique(museums_bg$subject_matter_simpl_aggr))
class18_simpl_aggr_types = class18_simpl_aggr_types[!is.na(class18_simpl_aggr_types)]

check_mm_valid(museums_bg)
```


## Basic stats & plots

```{r}
# SINGLE VARIABLES -----------------------------------------------------------------
basicfold = "../plots/basic_stats/single_var_stats/"
FUN_clean_folder(basicfold)

alldf = museums_bg@data

# general stats
FUN_dfsummary_to_file(alldf, paste0(basicfold,"allmus_summary_stats.txt"))
FUN_dfsummary_to_file(museums2022sdf, paste0(basicfold,"mus2022_summary_stats.txt"))

format_data_for_summary = function(x){
  x = as.character( x )
  x[is.na(x)] = "NOT_AVAIL"
  x[x==''] = "NOT_AVAIL"
  x = as.factor(x)
  x
}

# stats for each categorical attribute
for (var in c("subject_matter","subject_matter_simpl","subject_matter_simpl_aggr",
              "accreditation",'size',
              'governance','governance_simpl',
              "country_name","region_name")){
              
  # ALL MUSEUMS
  print(var)
  x = format_data_for_summary( alldf[,c(var)] )
  df = p_summary_list( x, paste0('all_museums-',var) )
  df = subset(df,df$VAL.Freq > 0)
  write_xlsx(df, paste0(basicfold, 'allmus_summary_var-',var,".xlsx") )
  
  # 2022 MUSEUMS
  x = format_data_for_summary( museums2022sdf@data[,var] )
  df = p_summary_list( x, paste0('mus2022-',var) )
  df = subset(df,df$VAL.Freq > 0)
  write_xlsx(df, paste0(basicfold, 'mus2022_summary_var-',var,".xlsx") )
  rm(df,x)
}

names(museums2022sdf)

# ------------------------------------------------------------------------
# calculate stats for two variables

FUN_clean_folder("../plots/basic_stats/two_var_stats/")

for(var1 in c("size","subject_matter","governance_simpl","subject_matter_simpl","accreditation","country_name")){
  for(var2 in c("governance","governance_simpl","accreditation","subject_matter","subject_matter_simpl","region_name")){
    if (var1!=var2) FUN_twoVarStats(museums_bg@data, var1, var2, '../plots/basic_stats/two_var_stats/allmus_')
    if (var1!=var2) FUN_twoVarStats(museums2022sdf@data, var1, var2, '../plots/basic_stats/two_var_stats/mus2022_')
    if (var1!=var2) FUN_twoVarStats(museums2022sdf@data, var2, var1, '../plots/basic_stats/two_var_stats/mus2022_')
  }
}

# custom stats for Fiona
#
# I've had a look at the plots. I was wondering if there is a way of generating comparisons across
# the summaries? So, I'm looking at mus2022_summary_var-classification_2018-just_accredited.xlsx
# and the equivalent for total 2022 museums. What's surprising is that there isn't a huge amount of difference 
# in the overall distribution of subject matter, or at least as far as I can see (Large houses jumps up). 
# BUT would it be possible to generate a table that calculated percentage increase (So if we go from accredited 
# museums to all2022 museums, large houses jumps +2%, transport +1% and so on? that would make it much 
# easier for me to see where change happens.
# Also, would you generate a summary table for unaccredited museums please?

# 2022 MUSEUMS class 18 stats
for (var in c("subject_matter","subject_matter")){
  df = as.data.frame.matrix(table(museums2022sdf[,c(var,"accreditation")]))
  #print(nrow(mus))
  df$V1=NULL
  df$all2022 = rowSums(df)
  print(sum(df$all2022))
  df$all2022_PC = round(df$all2022/nrow(museums2022sdf)*100,2)
  df$Accredited_PC = round(df$Accredited/nrow(museums2022sdf)*100,2)
  df$Unaccredited_PC = round(df$Unaccredited/nrow(museums2022sdf)*100,2)
  #df$variation_PC = df$Accredited_PC - df$Unaccredited_PC
  df$accr_gain_PC = df$Accredited_PC - df$Unaccredited_PC
  df$accr_variation_PC = ifelse( df$Unaccredited_PC > 0, 
    round( (df$Accredited_PC-df$Unaccredited_PC)/df$Unaccredited_PC*100,1),
    NA)
  `*` = row.names(df)
  df = cbind( `*`, df )
  fn = paste0('../plots/basic_stats/two_var_stats/mus2022_summary_2var_extended-',var,"-vs-accreditation.xlsx")
  write_xlsx(df, fn)
  rm(df,var)
}

# compare size classifications
for(var1 in c("size","aim_size_designation","accreditation")){
  for(var2 in c("ace_size_designation","aim_size_designation")){
    if (var1!=var2) FUN_twoVarStats(alldf, var1, var2, '../plots/basic_stats/two_var_stats/allmus_')
    if (var1!=var2) FUN_twoVarStats(museums2022sdf, var1, var2, '../plots/basic_stats/two_var_stats/mus2022_')
}}

rm(var1,var2,basicfold,museums2022sdf)
rm(alldf)
rm(format_data_for_summary)
```
## Overview maps

```{r overview_map, eval=T}
# OVERVIEW map - plot all museums
uk_countries_2011_simp_bg <- spTransform(uk_countries_2011_simp, british_grid_crs)
uk_countries_reg_2011_bg <- spTransform(uk_countries_reg_2011, british_grid_crs)
uk_countries_reg_2011_simpl_bg <- spTransform(uk_countries_reg_2011_simpl, british_grid_crs)
tit = '' #paste0("Museums (N=",nrow(museums_bg),")")

# clean up
FUN_clean_folder("../plots/maps/overview_maps/")

gen_overview_map = function(sdf, bbox, mus_col, border_col, shape_col, facet_var, fout){

  outfolder = '../plots/maps/overview_maps/'
  attribution = tm_credits(get_plot_subtitle(paste0(outfolder,fout)), position = c("center","bottom"),alpha=.5)
  layout = tm_layout(frame=F,
      panel.label.size = 1.0, panel.label.color = 'black',
      panel.label.bg.color = NA, panel.label.height = 1.0)

  if (is.na(shape_col)){
    stopifnot(!is.na(border_col))
    # full shapes
    dot_map <-
      tmap::tm_shape(sdf, simplify = .5, bbox = bbox) +
        #tm_polygons(col='gray85', border.col = 'white', lwd=2) +
        tm_borders(col = border_col, lwd = 1.5, alpha = 1) +
      tmap::tm_shape(museums_bg) + tmap::tm_symbols( col=mus_col, size=.2, alpha = .3, border.lwd = NA ) +
      #tm_shape(get_cities_for_labels(80000)) + # load cities
      #tm_text("name", col = "gray", size = .2, alpha = .7, auto.placement = F) + # city labels
      tm_legend(scale=0.45,position=c("right","top"), title=tit) + #, bg.color = "white", bg.alpha=.2,
      attribution + layout
       #, attr.outside = TRUE, title="PINUZZU",
                #outer.margins=c(.1,0,.0,0),title.position = c("center","bottom"))

  } else {
    # empty shapes
    stopifnot(is.na(border_col))
    dot_map <-
      tmap::tm_shape(sdf, simplify = .5, bbox = bbox) +
        tm_polygons(col=shape_col, border.col = 'white', lwd=2) +
        #tm_borders(col = border_col, lwd = 1.5, alpha = 1) +
      tmap::tm_shape(museums_bg) + tmap::tm_symbols( col=mus_col, size= .2, alpha = .3, border.lwd = NA ) +
      #tm_shape(get_cities_for_labels(80000)) + # load cities
      #tm_text("name", col = "gray", size = .2, alpha = .7, auto.placement = F) + # city labels
      tm_legend(scale=0.45,position=c("right","top"), title=tit) + #, bg.color = "white", bg.alpha=.2,
      attribution + layout
  }

  if (!is.na(facet_var)){
    dot_map <- dot_map + tm_facets(facet_var,free.scales=FALSE)
  }

  #dot_map
  tmap_save(dot_map,paste0(outfolder,fout,'.png'))
  tmap_save(dot_map,paste0(outfolder,fout,'.pdf'))

  rm(dot_map)
}


museumBboxBg <- bbox(museums_bg)

gen_overview_map(uk_countries_reg_2011_simpl_bg, museumBboxBg, mus_col='steelblue3', border_col=NA,
                 shape_col='gray85', facet_var=NA, fout='museums_overview_points1' )
gen_overview_map(uk_countries_reg_2011_simpl_bg, museumBboxBg, mus_col='steelblue3', border_col=NA,
                 shape_col='gray55', facet_var=NA, fout='museums_overview_points2' )
gen_overview_map(uk_countries_reg_2011_simpl_bg, museumBboxBg, mus_col='steelblue3', border_col='gray55',
                 shape_col=NA, facet_var=NA, fout='museums_overview_points3' )

# Multiple DOT MAP BY GOVERNANCE and SIZE
gen_overview_map(uk_countries_reg_2011_simpl_bg, museumBboxBg, mus_col='steelblue2', border_col=NA,
                 shape_col="gray85", facet_var="governance_simpl", fout='museums_overview_points_gov_mult' )
gen_overview_map(uk_countries_reg_2011_simpl_bg, museumBboxBg, mus_col='steelblue2', border_col=NA,
                 shape_col="gray85", facet_var="size", fout='museums_overview_points_size_mult' )

# Multiple DOT MAP BY CLASSIF18
gen_overview_map(uk_countries_reg_2011_simpl_bg, museumBboxBg, mus_col='steelblue2', border_col=NA,
                 shape_col="gray85", facet_var="subject_matter_simpl", fout='museums_overview_points_subject_matter_simpl' )


gen_categorical_map <- function( catField, ptSz, fout ){
  outfolder = '../plots/maps/overview_maps/'
    m <-
      tmap::tm_shape(uk_countries_reg_2011_simpl_bg, simplify = .5, bbox = museumBboxBg) +
        tm_polygons(col='gray85', border.col = 'white', lwd=2, alpha=.5) +
      tmap::tm_shape(museums_bg) +
      tm_credits(get_plot_subtitle(paste0(outfolder,fout)), position = c("center","bottom"),alpha=.5) +
      tmap::tm_symbols( catField, style='cat', palette="Set1", size= ptSz, alpha = .5, border.lwd = NA )

      #tm_shape(get_cities_for_labels(80000)) + # load cities
      #tm_text("name", col = "gray", size = .2, alpha = .7, auto.placement = F) + # city labels
      #tm_legend(scale=0.45,position=c("right","top"), title=tit) + #, bg.color = "white", bg.alpha=.2,
      #tm_layout(frame=F)
    #dot_map
    tmap_save(m,paste0(outfolder,fout,'.png'),width = 5)
    tmap_save(m,paste0(outfolder,fout,'.pdf'),width = 5)
}

gen_categorical_map('size', .1, 'museums_overview_points_size1')
gen_categorical_map('size', .2, 'museums_overview_points_size2')
gen_categorical_map('governance_simpl', .1, 'museums_overview_points_govern1')
gen_categorical_map('governance_simpl', .2, 'museums_overview_points_govern2')

rm(museumBboxBg)

```


## Region and LAD stats

```{r regions, eval=T}

FUN_clean_folder("../plots/maps/geo_stats")

plot_stacked_barcharts = function(df, varx, vary, groupvar, labx, laby, 
                            plot_title, fn){
  print(paste0('plot_stacked_barcharts',fn))
  write_xlsx(df,paste0(fn,'.xlsx'))
  
  fout = paste0(fn,'.png')
  g = ggplot(data=df, aes_string(x=varx, y=vary, fill=groupvar)) +
      geom_bar(stat="identity",colour="white",alpha=.9) + theme_light() +
      geom_text(aes(label=n), position = position_stack(vjust = 0.5), hjust=.5, size=2, color='white') +
      ylab(laby) + xlab(labx) + coord_flip() +
      ggtitle(plot_title, subtitle = get_plot_subtitle(fout))
  ggsave(plot = g, filename = fout,width = 8, height = 4)
  ggsave(plot = g, filename = paste0(fout,'.pdf'),width = 8, height = 4)

  # bar chart for size in regions (percent)
  fout = paste0(fn,'_percent.png')
  g = ggplot(data=df, aes_string(x=varx, y=vary, fill=groupvar)) +
      geom_bar(stat="identity",colour="white",alpha=.9,position = 'fill') + theme_light() +
      geom_text(aes(label=n), position = position_fill(vjust = 0.5), hjust=.5, size=2, color='white') +
      ylab(paste0(laby,' (%)')) + xlab(labx) + coord_flip() + 
      scale_y_continuous(labels = percent_format()) +
      ggtitle(paste0(plot_title,' (%)'), subtitle = get_plot_subtitle(fout))
  ggsave(plot = g,filename = fout,width = 8, height = 4)
  ggsave(plot = g,filename = paste0(fout,'.pdf'),width = 8, height = 4)
}

nrow(museums_bg)

write_tsv(museums_bg@data[,c("museum_id","country_gss","country_name",
                             "region_gss","region_name")],
          "../datasets/museums/museums_country_regions.tsv")

gen_stats_country_region = function(musdf, lab){
  print(paste0('gen_stats_country_region',lab))
  
  # stats by UK country
  for (v in c('size','governance_simpl')){
    stats_df = FUN_count_groups_by_vars(musdf, c("country_gss", v))
    stats_df = merge(stats_df, uk_countries_2011@data, by.x="country_gss", by.y="GSS")
    # change order for plotting
    stats_df[,v] = FUN_order_factor(stats_df[,v], rev(levels(stats_df[,v])),F)
    stats_df$NAME = FUN_order_factor(stats_df$NAME, 
                                     c("Northern Ireland","Scotland","Wales","England"), F)
    plot_stacked_barcharts(stats_df,'NAME','n',v,'UK country','N museums',
                  paste0('Museums in UK countries by ',v),
                  paste0('../plots/maps/geo_stats/museums',lab,'_in_country_by_',v))
  }

  # stats by English regions
  df = subset(musdf, musdf$country_name == 'England' )
  df$region_gss = as.factor(as.character(df$region_gss))
  for (v in c('size','governance_simpl')){
    stats_df = FUN_count_groups_by_vars(df, c("region_gss", v))
    
    stats_df = merge(stats_df, uk_countries_reg_2011_bg@data, by.x="region_gss", by.y="GSS")
    stats_df$NAME = as.factor(as.character(stats_df$NAME))
    # change order for plotting
    stats_df$NAME = FUN_order_factor(stats_df$NAME, 
                                     rev(levels(stats_df$NAME)),F)
    stats_df[,v] = FUN_order_factor(stats_df[,v], rev(levels(stats_df[,v])),F)
    plot_stacked_barcharts(stats_df,'NAME','n',v,'English region','N museums',
                         paste0('Museums in English Regions by ',v),
                         paste0('../plots/maps/geo_stats/museums',lab,'_in_region_by_',v))
  }
  
  rm(df,stats_df)
}

stopifnot(nrow(museums2022sdf)>0)

gen_stats_country_region(museums_bg@data,'all')
gen_stats_country_region(museums2022sdf@data,'22')

# -------------------------------------------------
# Generate stats for all museums in LADs 2011
# -------------------------------------------------

stopifnot( nrow(museums_bg) > 3000 )

lads11 = load_uk_dataset('uk_local_auth_alt_2011-full.rds')

units_over <- sp::over(spTransform(museums_bg, proj4string(lads11)), lads11)
colnames(units_over) = c("UNIT_GSS","UNIT_NAME")
summary(units_over)
all_museums_bg <- spCbind(museums_bg, units_over)
all_museums_bg$UNIT_GSS = as.factor(trimws(all_museums_bg$UNIT_GSS))
all_museums_bg$GSS = NULL
all_museums_bg$NAME = NULL

allmus_lad11 = FUN_summarise_museum_by_spatial_unit(all_museums_bg@data)
allmus_lad11$VARVAL = as.factor( paste0(allmus_lad11$VAR,'-',allmus_lad11$VAL) )
allmus_lad11d = dcast( allmus_lad11, UNIT_GSS~VARVAL, value.var = "n_museums" )
names(allmus_lad11d)[1] = 'GSS'
allmus_lad11d_wnames = merge(allmus_lad11d, lads11@data, by='GSS')

# move new column to first
allmus_lad11d_wnames = allmus_lad11d_wnames[,c(ncol(allmus_lad11d_wnames), 1:ncol(allmus_lad11d_wnames)-1)]

names(allmus_lad11d_wnames)[1:2] = c('LAD11_NAME','LAD11_GSS')

write_xlsx(allmus_lad11d_wnames,'../plots/maps/geo_stats/allmuseums_LAD11_counts.xlsx')

names(allmus_lad11)[1] = 'GSS'
allmus_lad11 = merge(allmus_lad11, lads11@data, by='GSS', all.x=T)
allmus_lad11 = allmus_lad11[,c(1,6,2,3,4)]
names(allmus_lad11)[1:2] = c('LAD11_GSS','LAD11_NAME')
write_xlsx(allmus_lad11,'../plots/maps/geo_stats/allmuseums_LAD11_counts_long.xlsx')
write_tsv( allmus_lad11, '../datasets/museums/allmuseums_LAD11_counts_long.tsv')

rm(units_over, all_museums_bg, allmus_lad11, allmus_lad11d_wnames, lads11)

```

## Open/closing analysis

from 2018 Jan - Research questions re visualisation.docx

5. Museums closing over time. Ditto I'm unsure of the best way to visualise much of this information but possibly stacked bar charts with a line graph for the first topic.
"	Museums by years of closing
"	Museums closing, over time, by governance and its sub-categories.
"	Museums closing, over time, by subject and its sub-categories. (BUT too many)
"	Museums closing, over time, by size and its sub-categories.
"	Museums closing over time, by location and its sub-categories. (BUT too many)

6. Opening versus closing depicted via line graph (?)
"	All museums opening vs all museums closing over time and by sub-category to incl. each type of museum by opening and by closing

### Open/closings stats by year

```{r closing_analysis, eval=T}

#closing_plot_counter <<- 0
check_mm_valid(museums_bg)

FUN_clean_folder("../plots/openclose/openclose_years/")

# function to produce charts ----------------
plot_openings_closings = function(df, title, outfile, smooth_span = 0.2){
  #closing_plot_counter <<- closing_plot_counter+1
  print(paste("plot_openings_closings"))#,closing_plot_counter))

  ylabel = 'Number of Museums'
  n_info = '' #paste0(" [obs N=",nrow(df),"]")
  
  # plot LINES raw
  p = ggplot(df, aes(year, value, group=variable, color=variable, linetype=variable)) + # 
    scale_linetype_manual(values = FUN_get_random_linetypes(unique(df$variable))) +
    geom_line(size=.8) + #geom_point(size=1) +
    #stat_smooth(inherit.aes = T, fullrange = T) +
    ggtitle(paste0(title,n_info), subtitle = get_plot_subtitle(outfile,'-raw')) +
    xlab("Year") + ylab(ylabel) +
    geom_hline(yintercept = 0,alpha=.5) +
    scale_x_continuous(breaks = seq(min(years_df$year), max(years_df$year),5)) +
    theme_light() +  theme(panel.grid.minor.x = element_line(colour = NA),
      panel.grid.major.x = element_line(colour = "darkgray"))

  ggsave(paste0(outfile,'-raw.pdf'), p, width = 11)
  ggsave(paste0(outfile,'-raw.png'), p, width = 11)

  # plot SMOOTHED
  p = ggplot(df, aes(year, value, group=variable, color=variable, linetype=variable )) + 
        scale_linetype_manual(values = FUN_get_random_linetypes(unique(df$variable))) +
  #geom_line() + geom_point(size=1) +
    #stat_smooth(inherit.aes = T, fullrange = T) +
    #stat_smooth(method = "loess", formula = y ~ x, size = 1) +
    geom_smooth( span = smooth_span, se = F ) +  # SMOOTHING FUNCTION
    ggtitle(paste0(title,n_info," [smoothed]"), subtitle = get_plot_subtitle(outfile,"-smooth")) +
    xlab("Year") + ylab(ylabel) +
    geom_hline(yintercept = 0,alpha=.5) +
    scale_x_continuous(breaks = seq(min(years_df$year), max(years_df$year),5)) +
    theme_light() +  theme(panel.grid.minor.x = element_line(colour = NA),
     panel.grid.major.x = element_line(colour = "darkgray"))

  ggsave(paste0(outfile,'-smooth.pdf'), p, width = 11)
  ggsave(paste0(outfile,'-smooth.png'), p, width = 11)

  # plot SMOOTHED with ERROR
  p = ggplot(df, aes(year, value, group=variable, color=variable)) +  # , linetype=variable
  #geom_line() + geom_point(size=1) +
    #stat_smooth(inherit.aes = T, fullrange = T) +
    #stat_smooth(method = "loess", formula = y ~ x, size = 1) +
    geom_smooth( span = 0.2, se = T ) +  # SMOOTHING FUNCTION
    ggtitle(paste0(title,n_info," [smoothed+stdev]"), 
            subtitle = get_plot_subtitle(outfile,"-smooth_stdev")) +
    xlab("Year") +ylab(ylabel) +
    geom_hline(yintercept = 0,alpha=.5) +
    scale_x_continuous(breaks = seq(min(years_df$year), max(years_df$year),5)) +
    theme_light() +  theme(panel.grid.minor.x = element_line(colour = NA),
     panel.grid.major.x = element_line(colour = "darkgray"))

  ggsave(paste0(outfile,'-smooth_stdev.pdf'), p, width = 11)
  ggsave(paste0(outfile,'-smooth_stdev.png'), p, width = 11)

  # plot PERCENTAGE
  p = ggplot(df, aes(year, value, group=variable, color=variable, fill=variable)) +
    #geom_smooth( span = 0.2, se = T ) +  # SMOOTHING FUNCTION
    geom_area(position = "fill", stat="identity", color='darkgray', alpha=.7) +
    ggtitle(paste0(title,n_info," [percentage]"), subtitle = get_plot_subtitle(outfile,"-percent")) +
    xlab("Year") +ylab(ylabel) +
    geom_hline(yintercept = 0,alpha=.5) +
    scale_y_continuous(labels = percent_format()) +
    scale_x_continuous(breaks = seq(min(years_df$year), max(years_df$year),5)) +
    theme_light() +  theme(panel.grid.minor.x = element_line(colour = NA),
     panel.grid.major.x = element_line(colour = "darkgray"))

  ggsave(paste0(outfile,'-percent.png'), p, width = 11)
}
# ----------------------------

stopifnot(nrow(museums_bg)>3000)

# filter museums for analysis
mdf = museums_bg #[museums_bg$year_opened_BEG >= 1950, ]
stopifnot( nrow(mdf)==ALL_MUSEUMS_N )

# OPENINGS/CLOSINGS by years
#all_years = seq(min(mdf$year_opened_BEG,na.rm = T), max(mdf$year_closed_END,na.rm = T))

# get advanced stats per year
get_stats_by_year = function(mdf, year){
  stopifnot( nrow(mdf)>3000 )
  row = data.frame( year = year, decade = paste0(substr(as.character(year),1,3),0) )
  stopifnot(nrow(row)==1)
  # ----------------------------------------------------------------------------
  # OPENINGS
  # ----------------------------------------------------------------------------
  # get all rows
  opened = subset(mdf, mdf$year_opened_BEG <= year & year <= mdf$year_opened_END )
  # calculate opening with Nick's formula
  opened$year_opened_PROB = FUN_get_openings_over_time(opened, year)
  #opened$year_opened_PROB_min = FUN_get_openings_over_time_min(opened, year)
  #opened$year_opened_PROB_max = FUN_get_openings_over_time_max(opened, year)
  
  flatten_results = function(vals){
    v = as.vector( unlist( vals ) )
    stopifnot(length(v)==1 || length(v)==2)
    v = v[1]
    return(v)
  }
  
  n = nrow(opened)
  row$opening_N = n
  row$opening_wei_N = round( sum(opened$year_opened_PROB), 2)
  #row$opening_wei_N_min = round( sum(opened$year_opened_PROB_min), 2)
  #row$opening_wei_N_max = round( sum(opened$year_opened_PROB_max), 2)
  
  # get GOVERNANCE stats OPEN (simplified)
  gov_summary <- dplyr::summarise( group_by(opened, governance_simpl),
    n = n(),
    w = round(sum(year_opened_PROB),1)
  )
  for (gov in gov_types_simpl){
    if ( nrow(gov_summary[ gov_summary$governance_simpl == gov,])>0)
      val = gov_summary[ gov_summary$governance_simpl == gov,"w"]
    else val = 0
    stopifnot(length(val)==1)
    row[ 1, paste0('open_gov_wei-',gov) ] = val
  }
  rm(gov_summary)
  
  # get ACCREDITATION stats OPEN
  accr_summary <- dplyr::summarise( group_by(opened, accreditation),
    n = n(),
    w = round(sum(year_opened_PROB),1)
  )
  for (accr in unique(opened$accreditation)){
    if ( nrow(accr_summary[ accr_summary$accreditation == accr,])>0)
      val = accr_summary[ accr_summary$accreditation == accr,"w"]
    else val = 0
    stopifnot(length(val)==1)
    row[ 1, paste0('open_accr_wei-',accr) ] = val
  }
  rm(accr_summary,accr)
  
  # get SIZE stats OPEN (simplified)
  sz_summary <- dplyr::summarise( group_by(opened, size),
    n = n(),
    w = round(sum(year_opened_PROB),1)
  )
  for (sz in size_categories){
    if ( nrow(sz_summary[ sz_summary$size == sz,])>0)
      val = sz_summary[ sz_summary$size == sz,"w"]
    else val = 0
    stopifnot(length(val)==1)
    row[ 1, paste0('open_size_wei-',sz) ] = val
  }
  rm(sz_summary)

  # get SUBJECT_MATTER stats OPEN (simplified)
  cl_summary <- dplyr::summarise( group_by(opened, subject_matter_simpl_aggr),
    n = n(),
    w = round(sum(year_opened_PROB),1)
  )

  for (cl in class18_simpl_aggr_types){
    if ( nrow(cl_summary[ cl_summary$subject_matter_simpl_aggr == cl,])>0){
      val = flatten_results( cl_summary[ cl_summary$subject_matter_simpl_aggr == cl,"w"] )
    } else val = 0
    stopifnot(length(val)==1)
    row[ 1, paste0('open_subjmatt_wei-',cl) ] = val
  }
  rm(cl,cl_summary)

  # get REGION stats OPEN
  reg_summary <- dplyr::summarise( group_by(opened, region_gss),
    n = n(),
    w = round(sum(year_opened_PROB),1)
  )
  for (reg in sort(unique(opened$region_gss))){
    if ( nrow(reg_summary[ reg_summary$region_gss == reg,])>0)
      val = flatten_results( reg_summary[ reg_summary$region_gss == reg, "w" ] )
    else val = 0
    stopifnot(length(val)==1)
    row[ 1, paste0('open_reg_wei-',reg) ] = val
  }
  rm(reg,reg_summary)

  # get country stats OPEN
  reg_summary <- dplyr::summarise( group_by(opened, country_gss),
    n = n(),
    w = round(sum(year_opened_PROB),1)
  )
  for (reg in sort(unique(opened$country_gss))){
    if ( nrow(reg_summary[ reg_summary$country_gss == reg,])>0)
      val = flatten_results( reg_summary[ reg_summary$country_gss == reg, "w" ] )
    else val = 0
    stopifnot(length(val)==1)
    row[ 1, paste0('open_country_wei-',reg) ] = val
  }
  rm(reg,reg_summary)

  rm(opened)
  # ----------------------------------------------------------------------------
  # CLOSINGS
  # ----------------------------------------------------------------------------
  # get all rows
  closed = subset(mdf, mdf$year_closed_BEG <= year & year <= mdf$year_closed_END )
  #print(opened$year_opened_PROB)
  n = nrow(closed)
  row$closing_N = n
  # calculate closing with Nick's formula
  closed$year_closed_PROB = FUN_get_closings_over_time(closed, year)
  row$closing_wei_N = round( sum(closed$year_closed_PROB), 2)
  # get governance stats CLOSE (simplified)
  gov_summary <- dplyr::summarise( group_by(closed, governance_simpl),
    n = n(),
    w = round(sum(year_closed_PROB),1)
  )
  for (gov in gov_types_simpl){
    if ( nrow(gov_summary[ gov_summary$governance_simpl == gov,])>0)
      val = flatten_results( gov_summary[ gov_summary$governance_simpl == gov,"w"] )
    else val = 0
    stopifnot(length(val)==1)
    row[ 1, paste0('close_gov_wei-',gov) ] = val
  }

  # get SIZE stats CLOSE (simplified)
  sz_summary <- dplyr::summarise( group_by(closed, size),
    n = n(),
    w = round(sum(year_closed_PROB),1)
  )
  for (sz in size_categories){
    if ( nrow(sz_summary[ sz_summary$size == sz,])>0)
      val = flatten_results( sz_summary[ sz_summary$size == sz,"w"] )
    else val = 0
    stopifnot(length(val)==1)
    row[ 1, paste0('close_size_wei-',sz) ] = val
  }
  rm(sz_summary)
  
  # get ACCREDITATION stats CLOSE
  accr_summary <- dplyr::summarise( group_by(closed, accreditation),
    n = n(),
    w = round(sum(year_closed_PROB),1)
  )
  for (accr in unique(closed$accreditation)){
    if ( nrow(accr_summary[ accr_summary$accreditation == accr,])>0)
      val = accr_summary[ accr_summary$accreditation == accr,"w"]
    else val = 0
    stopifnot(length(val)==1)
    row[ 1, paste0('close_accr_wei-',accr) ] = val
  }
  rm(accr_summary,accr)

  # get classification2018 stats closed (simplified)
  cl_summary <- dplyr::summarise( group_by(closed, subject_matter_simpl_aggr),
    n = n(),
    w = round(sum(year_closed_PROB),1)
  )
  stopifnot(length(class18_simpl_aggr_types)>0)
  for (cl in class18_simpl_aggr_types){
    if ( nrow(cl_summary[ cl_summary$subject_matter_simpl_aggr == cl,])>0){
      val = flatten_results( cl_summary[ cl_summary$subject_matter_simpl_aggr == cl,"w"] )
    }
    else val = 0
    stopifnot(length(val)==1)
    row[ 1, paste0('close_subjmatt_wei-',cl) ] = val
  }
  rm(cl_summary)

  # get regional stats CLOSE
  reg_summary <- dplyr::summarise( group_by(closed, region_gss),
    n = n(),
    w = round(sum(year_closed_PROB),1)
  )
  for (reg in sort(unique(mdf$region_gss))){
    if ( nrow(reg_summary[ reg_summary$region_gss == reg,])>0)
      val = flatten_results( reg_summary[ reg_summary$region_gss == reg, "w" ] )
    else val = 0
    stopifnot(length(val)==1)
    row[ 1, paste0('close_reg_wei-',reg) ] = val
  }
  rm(reg,reg_summary)

  # get country stats CLOSE
  reg_summary <- dplyr::summarise( group_by(closed, country_gss),
    n = n(),
    w = round(sum(year_closed_PROB),1)
  )
  for (reg in sort(unique(closed$country_gss))){
    if ( nrow(reg_summary[ reg_summary$country_gss == reg,])>0)
      val = flatten_results( reg_summary[ reg_summary$country_gss == reg, "w" ] )
    else val = 0
    stopifnot(length(val)==1)
    row[ 1, paste0('close_country_wei-',reg) ] = val
  }
  rm(reg,reg_summary)

  rm(closed)
  # ------ end of closed --------

  # diff
  row$diff_wei_N = row$opening_wei_N - row$closing_wei_N
  stopifnot(nrow(row)==1)
  return(row)
}
#rm(row)
#summary(mdf$year_opened_PROB)
# calc advanced stats for each year
years_df = data.frame()
for (y in all_years){
  print(y)
  row = get_stats_by_year(mdf@data, y)
  stopifnot(nrow(row)==1)
  #print(names(row))
  #print(names(years_df))
  #print(setdiff(names(row),names(years_df)))
  years_df = smartbind(years_df, row)
  rm(row)
}
years_df$decade = as.factor(years_df$decade)
summary(years_df)
View(years_df)
write_xlsx(years_df,'../plots/openclose/openclose_years/years_openclose_stats.xlsx')

# ------- plot values -------
# prep plotting
years_exp_df = reshape2::melt(years_df, measure.vars=c("closing_wei_N","opening_wei_N")) #,"diff_wei_N"
#View(years_exp_df)

# PLOT: openings closings by year
plot_openings_closings(years_exp_df,"Museum openings/closings: weighted values per year",
                       '../plots/openclose/openclose_years/openclose_year')

# PLOT: just closings by year
years_exp_df = reshape2::melt(years_df, measure.vars=c("closing_wei_N"))
plot_openings_closings(years_exp_df,"Museum closings: weighted values per year",'../plots/openclose/openclose_years/close_year')

# PLOT: openings by country
years_exp_df = reshape2::melt(years_df,
                  measure.vars=c("open_country_wei-E92000001","open_country_wei-N92000002",
                                "open_country_wei-S92000003",	"open_country_wei-W92000004"))
years_exp_df$variable = gsub( 'open_country_wei-', '', years_exp_df$variable)
years_exp_df$variable = replace_gss_codes(years_exp_df$variable)
summary(years_exp_df$variable)
plot_openings_closings(years_exp_df,"Museum openings: weighted values per year by country",'../plots/openclose/openclose_years/open_year_by_country')

# PLOT: closings by country
years_exp_df = reshape2::melt(years_df,
                  measure.vars=c("close_country_wei-E92000001","close_country_wei-N92000002",
                                "close_country_wei-S92000003",	"close_country_wei-W92000004"))
years_exp_df$variable = gsub( 'close_country_wei-', '', years_exp_df$variable)
years_exp_df$variable = replace_gss_codes(years_exp_df$variable)
summary(years_exp_df$variable)
plot_openings_closings(years_exp_df,"Museum closings: weighted values per year by country",'../plots/openclose/openclose_years/close_year_by_country')

# PLOT: openings by region
years_exp_df = reshape2::melt(years_df,
                  measure.vars=names(years_df)[grepl( 'open_reg_wei-E', names(years_df) )])
years_exp_df$variable = gsub( 'open_reg_wei-', '', years_exp_df$variable)
years_exp_df$variable = replace_gss_codes(years_exp_df$variable)
summary(years_exp_df$variable)
plot_openings_closings(years_exp_df,"Museum openings: weighted values per year by English region",'../plots/openclose/openclose_years/open_year_by_eng_reg')

# PLOT: closings by region
years_exp_df = reshape2::melt(years_df,
                  measure.vars=names(years_df)[grepl( 'close_reg_wei-E', names(years_df) )])
years_exp_df$variable = gsub( 'close_reg_wei-', '', years_exp_df$variable)
years_exp_df$variable = replace_gss_codes(years_exp_df$variable)
summary(years_exp_df$variable)
plot_openings_closings(years_exp_df,"Museum closings: weighted values per year by English region",'../plots/openclose/openclose_years/close_year_by_eng_reg')

rm(years_exp_df)

# PLOT: openings by accreditation
years_exp_df = reshape2::melt(years_df,
                  measure.vars=names(years_df)[grepl( 'open_accr_wei-', names(years_df) )])
years_exp_df$variable = gsub( 'open_accr_wei-', '', years_exp_df$variable)
summary(years_exp_df$variable)
plot_openings_closings(years_exp_df,"Museum openings: weighted values per year by Accreditation",'../plots/openclose/openclose_years/open_year_by_accreditation')

# PLOT: closings by region
years_exp_df = reshape2::melt(years_df,
                  measure.vars=names(years_df)[grepl( 'close_accr_wei-', names(years_df) )])
years_exp_df$variable = gsub( 'close_accr_wei-', '', years_exp_df$variable)
summary(years_exp_df$variable)
plot_openings_closings(years_exp_df,"Museum closings: weighted values per year by Accreditation",'../plots/openclose/openclose_years/close_year_by_accreditation')

years_exp_df90 = subset(years_exp_df, years_exp_df$year >= 1990)
plot_openings_closings(years_exp_df90,"Museum closings: weighted values per year by Accreditation",'../plots/openclose/openclose_years/close_year_by_accreditation1990')

rm(years_exp_df,years_exp_df90)


# ------- plot percentage change -------

years_df_pc = FUN_calc_percentage_change_df(years_df, c('year','decade'))
#View(years_df_pc)
write_xlsx(years_df_pc,'../plots/openclose/openclose_years/years_openclose_stats_pc_change.xlsx')

# prep plotting
years_exp_df = reshape2::melt(years_df_pc, measure.vars=c("closing_wei_N","opening_wei_N")) #,"diff_wei_N"
#View(years_exp_df)
#years_exp_df = subset( years_exp_df, !is.na(years_exp_df$value) )

# PLOT: openings closings by year (% change)
plot_openings_closings(years_exp_df,"Museum openings/closings: % change per year",
                       '../plots/openclose/openclose_years/openclose_year_pc_change')

# PLOT: openings by country (% change)
years_exp_df = reshape2::melt(years_df_pc,
                  measure.vars=c("open_country_wei-E92000001","open_country_wei-N92000002",
                                "open_country_wei-S92000003",	"open_country_wei-W92000004"))
years_exp_df$variable = gsub( 'open_country_wei-', '', years_exp_df$variable)
years_exp_df$variable = replace_gss_codes(years_exp_df$variable)
summary(years_exp_df$variable)
plot_openings_closings(years_exp_df,"Museum openings: weighted values per year by country (% change)",'../plots/openclose/openclose_years/open_year_by_country_pc_change')

rm(years_df_pc)
rm(years_exp_df)
```


### Open/closings cumulative

Calculate open closing cumul stats

```{r closing_analysis_cumul, eval=T}

check_mm_valid(museums_bg)
mdf = museums_bg

#mdf = mdf[seq(2511,2540),] # DEBUG

# clean up out folder
FUN_clean_folder("../plots/openclose/openclose_cumulative/")

#' Calculate open/close stats for museums 
#' @param nonZero raise error if data is empty 
#' @return a row with values
get_open_museums_by_year = function(year, all_df, var_name, var_value, nonZero = T){
  #print(paste("get_open_museums_by_year",var_name))
  if (var_name!='all'){
    df = all_df[ all_df[ , var_name ]==var_value, ]
  } else {
    df = all_df
  }
  if (nonZero) stopifnot(nrow(df)>0)
  
  
  row = data.frame( year = year, var_name = var_name, var_value = var_value )
  
  if (nrow(df)==0){
    # no museums, set values to 0
    row$cumul_open_wei_N = 0
    row$cumul_closed_wei_N = 0
    return(row)
  }
  
  probs = FUN_get_open_at_given_time(df, year)
  # get bounds
  probs_min = FUN_get_open_at_given_time(df, year, opt='min')
  probs_max = FUN_get_open_at_given_time(df, year, opt='max')
  stopifnot(probs_min <= probs)
  stopifnot(probs_max >= probs)
  row$cumul_open_wei_N = round(sum(probs),3)
  row$cumul_open_wei_N_min = round(sum(probs_min),3)
  row$cumul_open_wei_N_max = round(sum(probs_max),3)
  rm(probs,probs_min,probs_max)
  
  probs = FUN_get_close_at_given_time(df, year)
  # get bounds
  probs_min = FUN_get_close_at_given_time(df, year, opt='min')
  probs_max = FUN_get_close_at_given_time(df, year, opt='max')
  stopifnot(probs_min <= probs)
  stopifnot(probs_max >= probs)
  row$cumul_closed_wei_N = round(sum(probs),3)
  row$cumul_closed_wei_N_min = round(sum(probs_min),3)
  row$cumul_closed_wei_N_max = round(sum(probs_max),3)
  rm(probs,probs_min,probs_max)
  
  stopifnot(nrow(row)==1)
  return(row)
}

# SLOW
calc_cumulative_stats = function(mdf,lab){
  print(paste("calc_cumulative_stats N =",nrow(mdf),lab))
  #View(mdf[,c("year_opened","year_closed","year_opened_PROB","year_closed_PROB")])

  # calc advanced stats for each year
  openm_df = data.frame()
  
  stopifnot(nrow(mdf@data)>0)
  
  print(names(mdf))
  
  for (y in all_years){
    row = get_open_museums_by_year(y, mdf@data, 'all', 'all')
    stopifnot(nrow(row)==1)
    openm_df = rbind(openm_df,row)
    rm(row)
  }
  summary(openm_df)
  #View(openm_df)
  print('  cumulative by size')
  # cumulative by size
  for (val in as.character(unique(mdf$size))){
    for (y in all_years){
      row = get_open_museums_by_year(y, mdf@data,'size',val)
      stopifnot(nrow(row)==1)
      openm_df = rbind(openm_df,row)
      rm(row)
    }
  }
  
  # cumulative by governance
  print('  cumulative by gov')
  for (val in as.character(unique(mdf$governance))){
    for (y in all_years){
      row = get_open_museums_by_year(y, mdf@data,'governance',val)
      openm_df = rbind(openm_df,row)
      rm(row)
    }
  }
  
  # cumulative by governance_simpl
  print('  cumulative by governance_simpl')
  for (val in as.character(unique(mdf$governance_simpl))){
    for (y in all_years){
      row = get_open_museums_by_year(y, mdf@data,'governance_simpl',val)
      openm_df = rbind(openm_df,row)
      rm(row)
    }
  }
  
  # cumulative by country
  print('  cumulative by country')
  for (val in as.character(unique(mdf$country_gss))){
    for (y in all_years){
      row = get_open_museums_by_year(y, mdf@data,'country_gss',val)
      openm_df = rbind(openm_df,row)
      rm(row)
    }
  }
  print('...')
  # cumulative by region
  print('  cumulative by region')
  for (val in as.character(unique(mdf$region_gss))){
    for (y in all_years){
      row = get_open_museums_by_year(y, mdf@data,'region_gss',val)
      openm_df = rbind(openm_df,row)
      rm(row)
    }
  }
  
  # cumulative by LAD 2016 (local auth)
  print('  cumulative by LAD')
  for (val in as.character(unique(mdf$lad16_gss))){
    for (y in all_years){
      row = get_open_museums_by_year(y, mdf@data,'lad16_gss',val)
      openm_df = rbind(openm_df,row)
      rm(row)
    }
  }
  
  # cumulative by subject_matter_simpl
  print('  cumulative by subject_matter_simpl')
  for (val in as.character(unique(mdf$subject_matter_simpl))){
    for (y in all_years){
      row = get_open_museums_by_year(y, mdf@data,'subject_matter_simpl',val)
      openm_df = rbind(openm_df,row)
      rm(row)
    }
  }
  
  # cumulative by subject_matter
  print('  cumulative by subject_matter')
  for (val in as.character(unique(mdf$subject_matter))){
    for (y in all_years){
      row = get_open_museums_by_year(y, mdf@data,'subject_matter',val)
      openm_df = rbind(openm_df,row)
      rm(row)
    }
  }
  
  # get cumul weighted close museums (museums that are already closed + closing ones)
  #openm_df$cumul_closed_wei_N = openm_df$cumul_closed_N + openm_df$open_but_closing_wei_N
  print('save data')
  openm_df$var_name = as.factor(openm_df$var_name)
  openm_df$var_value = as.factor(openm_df$var_value)
  write_xlsx(openm_df,paste0('../plots/openclose/openclose_cumulative/years_openclose_stats_cumulative-',lab,'-full.xlsx'))
  cumul_years_df = openm_df[,c("year","var_name","var_value","cumul_open_wei_N","cumul_closed_wei_N")]
  #View(cumul_years)
  rm(openm_df)
  write_xlsx(cumul_years_df, paste0('../plots/openclose/openclose_cumulative/years_openclose_stats_cumulative-',lab,'.xlsx'))
  return(cumul_years_df)
}

# generate cumulative stats for all museums
cumul_years = calc_cumulative_stats(mdf,'mus_all')

# generate cumulative stats for independent museums
indmdf = subset(mdf, mdf$governance_simpl=='independent')
nrow(indmdf)
cumul_years_indep = calc_cumulative_stats(indmdf,'mus_indep')
rm(indmdf)

# generate cumulative stats for local auth museums
lauthmdf = subset(mdf, mdf$governance=='Government-Local_Authority')
nrow(lauthmdf)
cumul_years_lauth = calc_cumulative_stats(lauthmdf,'mus_lauth')
rm(lauthmdf)
```


Stats for Report 2022

```{r}
df = read_excel('../plots/openclose/openclose_cumulative/years_openclose_stats_pc_change.xlsx')
names(df) = c('year','var_name','var_value','cumul_open_wei_pc_change','cumul_close_wei_pc_change')
df$var_geo = replace_gss_codes_with_NAs(df$var_value)
df$var_geo[df$var_geo=='NA'] = ''
df = df[,c('year','var_name','var_value','var_geo','cumul_open_wei_pc_change','cumul_close_wei_pc_change')]

write_xlsx(df, '../plots/openclose/openclose_cumulative/years_openclose_stats_pc_change_report2022.xlsx')
rm(df)
```

Plot cumulative charts

```{r}
# ----------------------------------------
plot_cumul_openclose_charts <- function(df,title,fout, useFacets = F){
  width_sz = 8
  height_sz = 6
  # LINE PLOT (raw)
  p = ggplot(df, aes(year, value, group=variable, color=variable, linetype=variable)) + # 
    scale_linetype_manual(values = FUN_get_random_linetypes(unique(df$variable))) +
    geom_line(size=.8) + #geom_point(size=.5) +
    #scale_color_manual(values=c('darkgreen','red')) +
    #stat_smooth(inherit.aes = T, fullrange = T) +
    ggtitle(title, subtitle = get_plot_subtitle(fout,'-raw')) +
    xlab("Year") + ylab("Number of museums") +
    geom_hline(yintercept = 0, alpha=.5) +
    scale_x_continuous(breaks = seq(min(df$year), max(df$year), 5) ) +
    theme_light() +  theme(panel.grid.minor.x = element_line(colour = NA),
    panel.grid.major.x = element_line(colour = "darkgray"))

  ggsave(paste0(fout,'-raw.png'), p, width = width_sz)
  ggsave(paste0(fout,'-raw.pdf'), p, width = width_sz)
  
  # LINE PLOT (smoothed)
  #print(FUN_get_random_linetypes(unique(df$variable),T)) # DEBUG
  linetypes = as.character(FUN_get_random_linetypes(unique(df$variable),T))
  p = ggplot(df, aes(year, value, group=variable, color=variable, linetype=variable)) + 
    scale_linetype_manual(values = linetypes) +
    #geom_line(line=2) + geom_point(size=1) +
    #scale_color_manual(values=c('darkgreen','red')) +
    geom_smooth( span = 0.2, se = F ) +  # SMOOTHING FUNCTION
    ggtitle(paste0(title," [smoothed]"), subtitle = get_plot_subtitle(fout,"-smooth")) +
    xlab("Year") + ylab("Number of museums") +
    geom_hline(yintercept = 0, alpha=.5) +
    scale_x_continuous(breaks = seq(min(df$year), max(df$year), 5) ) +
    theme_light() +  theme(panel.grid.minor.x = element_line(colour = NA),
    panel.grid.major.x = element_line(colour = "darkgray"))

  if (useFacets){
    # split according to 'facet' variable vertically
    height_sz = height_sz*1.7
    p = p + facet_grid(facet ~ .)
  }
  ggsave(paste0(fout,'-smooth.png'), p, width=width_sz, height=height_sz)
  ggsave(paste0(fout,'-smooth.pdf'), p, width=width_sz, height=height_sz)

  bar_alpha = .8
  # stacked bars
  p = ggplot(df, aes(year, value, group=variable, color=variable, fill=variable)) +
    #geom_line(line=2) + geom_point(size=1) +
    #scale_color_manual(values=c('darkgreen','red')) +
    #geom_smooth( span = 0.2, se = F ) +  # SMOOTHING FUNCTION
    geom_area(position = 'stack',alpha=bar_alpha,color='white') +
    ggtitle(paste0(title," [stacked]"), subtitle = get_plot_subtitle(fout,"-stack")) +
    xlab("Year") + ylab("Number of museums") +
    geom_hline(yintercept = 0, alpha=.5) +
    scale_x_continuous(breaks = seq(min(df$year), max(df$year), 5) ) +
    theme_light() +  theme(panel.grid.minor.x = element_line(colour = NA),
    panel.grid.major.x = element_line(colour = "darkgray"))

  ggsave(paste0(fout,'-stacked.png'), p, width=width_sz, height=height_sz)
  ggsave(paste0(fout,'-stacked.pdf'), p, width=width_sz, height=height_sz)

  # stacked bars percentage
  p = ggplot(df, aes(year, value, group=variable, color=variable, fill=variable)) +
    geom_area(position = "fill",stat = "identity", color='white', alpha=bar_alpha) +
    ggtitle(paste0(title," [percentage]"), subtitle = get_plot_subtitle(fout,"-percent")) +
    xlab("Year") + ylab("% of museums") +
    geom_hline(yintercept = 0, alpha=.5) +
    scale_x_continuous(breaks = seq(min(df$year), max(df$year), 5) ) +
    scale_y_continuous(labels = percent_format()) +
    theme_light() +  theme(panel.grid.minor.x = element_line(colour = NA),
    panel.grid.major.x = element_line(colour = "darkgray"))

  ggsave(paste0(fout,'-percent.png'), p, width=width_sz, height=height_sz)
  ggsave(paste0(fout,'-percent.pdf'), p, width=width_sz, height=height_sz)

  rm(p)
}
# -------------------------------------

# PLOT cumulative stats Open museums (WEIGHTED)
df = subset( cumul_years, cumul_years$var_name == 'all' )[,c("year","cumul_open_wei_N")]
df = melt(df,id.vars = c("year"))
names(df)
title = "Cumulative opened museums per year (weighted)"
fout = "../plots/openclose/openclose_cumulative/cumul_open_museums_wei_years"
plot_cumul_openclose_charts(df,title,fout)
rm(df)

# PLOT cumulative stats Open museums (WEIGHTED vs UNWEIGHTED)
#df = subset( cumul_years, cumul_years$var_name == 'all' )[,c("year","cumul_open_unwei_N","cumul_open_wei_N")]
#df = melt(df,id.vars = c("year"))
#names(df)
#title = "Cumulative opened museums per year (weighted)"
#fout = "../plots/openclose/openclose_cumulative/cumul_open_museums_wei_vs_unwei_years"
#plot_cumul_openclose_charts(df,title,fout)
#rm(df)

# # PLOT cumulative stats Open museums (UNWEIGHTED)
# df = subset( cumul_years, cumul_years$var_name == 'all' )[,c("year","cumul_open_unwei_N","cumul_closed_N")]
# df = melt(df,id.vars = c("year"))
# names(df)
# title = "Cumulative opened and closed museums (weighted)"
# fout = "../plots/openclose/openclose_cumulative/cumul_openclose_museums_unwei_years"
# plot_cumul_openclose_charts(df,title,fout)
# rm(df)

# PLOT cumul OPEN museums by size
df = subset( cumul_years, cumul_years$var_name == 'size' )[,c("year","var_value","cumul_open_wei_N")]
colnames(df) = c("year","variable","value")
names(df)
stopifnot(nrow(df)>0)
title = "Cumulative open museums by simpl size (weighted)"
fout = "../plots/openclose/openclose_cumulative/cumul_open_museums_size"
plot_cumul_openclose_charts(df, title, fout)
rm(df)

# PLOT cumul CLOSED museums by size
df = subset( cumul_years, cumul_years$var_name == 'size' )[,c("year","var_value","cumul_closed_wei_N")]
colnames(df) = c("year","variable","value")
names(df)
stopifnot(nrow(df)>0)
title = "Cumulative close museums by simpl size (weighted)"
fout = "../plots/openclose/openclose_cumulative/cumul_close_museums_size"
plot_cumul_openclose_charts(df, title, fout)
rm(df)

# PLOT cumul OPEN museums by gov
df = subset( cumul_years, cumul_years$var_name == 'governance_simpl' )[,c("year","var_value","cumul_open_wei_N")]
colnames(df) = c("year","variable","value")
names(df)
stopifnot(nrow(df)>0)
title = "Cumulative open museums by simpl governance (weighted)"
fout = "../plots/openclose/openclose_cumulative/cumul_open_museums_gov"
plot_cumul_openclose_charts(df, title, fout)
rm(df)

# PLOT cumul CLOSED museums by gov
df = subset( cumul_years, cumul_years$var_name == 'governance_simpl' )[,c("year","var_value","cumul_closed_wei_N")]
colnames(df) = c("year","variable","value")
names(df)
stopifnot(nrow(df)>0)
title = "Cumulative close museums by simpl governance (weighted)"
fout = "../plots/openclose/openclose_cumulative/cumul_close_museums_gov"
plot_cumul_openclose_charts(df, title, fout)
rm(df)

cumul_years = subset(cumul_years, !is.na(cumul_years$var_value))
cumul_years$var_value = as.factor(as.character(cumul_years$var_value))

# PLOT cumul OPEN museums by country
df = subset( cumul_years, cumul_years$var_name == 'country_gss' )[,c("year","var_value","cumul_open_wei_N")]
colnames(df) = c("year","variable","value")
names(df)
df$variable = replace_gss_codes(df$variable)
stopifnot(nrow(df)>0)
title = "Cumulative open museums by UK country (weighted)"
fout = "../plots/openclose/openclose_cumulative/cumul_open_museums_country"
plot_cumul_openclose_charts(df, title, fout)
rm(df)

# PLOT cumul CLOSED museums by country
df = subset( cumul_years, cumul_years$var_name == 'country_gss' )[,c("year","var_value","cumul_closed_wei_N")]
colnames(df) = c("year","variable","value")
names(df)
df$variable = replace_gss_codes(df$variable)
stopifnot(nrow(df)>0)
title = "Cumulative close museums by UK country (weighted)"
fout = "../plots/openclose/openclose_cumulative/cumul_close_museums_country"
plot_cumul_openclose_charts(df, title, fout)
rm(df)

# PLOT cumul open museums by region + country
df = subset( cumul_years, cumul_years$var_name == 'region_gss' )[,c("year","var_value","cumul_open_wei_N")]
colnames(df) = c("year","variable","value")
names(df)
df$variable = replace_gss_codes(df$variable)
stopifnot(nrow(df)>0)
title = "Cumulative open museums by country/region (weighted)"
fout = "../plots/openclose/openclose_cumulative/cumul_open_museums_regioncountry"
plot_cumul_openclose_charts(df, title, fout)
rm(df)

# PLOT cumul closed museums by region + country
df = subset( cumul_years, cumul_years$var_name == 'region_gss' )[,c("year","var_value","cumul_closed_wei_N")]
colnames(df) = c("year","variable","value")
names(df)
df$variable = replace_gss_codes(df$variable)
stopifnot(nrow(df)>0)
title = "Cumulative close museums by country/region (weighted)"
fout = "../plots/openclose/openclose_cumulative/cumul_close_museums_regioncountry"
plot_cumul_openclose_charts(df, title, fout)
rm(df)
rm(fout,title)

# PLOT cumul open museums by English region
df = subset( cumul_years, cumul_years$var_name == 'region_gss' &
               grepl( 'E12', cumul_years$var_value ) )[,c("year","var_value","cumul_open_wei_N")]
colnames(df) = c("year","variable","value")
names(df)
df$variable = replace_gss_codes(df$variable)
stopifnot(nrow(df)>0)
title = "Cumulative open museums by English region (weighted)"
fout = "../plots/openclose/openclose_cumulative/cumul_open_museums_engreg"
plot_cumul_openclose_charts(df, title, fout)
rm(df)
```

PLOT cumulative PC change

```{r}

cumul_years_pc <- foreach(block=split(cumul_years, cumul_years[,c("var_name",'var_value')]), .combine='rbind', .errorhandling="stop") %do% {
  if(nrow(block)==0) return(NULL)
  df = FUN_calc_percentage_change_df(block, c('year','var_name','var_value'))
  return(df)
}
#View(cumul_years_pc)
#View(years_df_pc)
write_xlsx(cumul_years_pc,'../plots/openclose/openclose_cumulative/years_openclose_stats_pc_change.xlsx')

# PLOT cumulative stats Open/close museums (WEIGHTED)
df = subset( cumul_years_pc, cumul_years_pc$var_name == 'all' )[,c("year",'cumul_closed_wei_N',"cumul_open_wei_N")]
df = melt(df,id.vars = c("year"))
names(df)
title = "Cumulative opened/closed museums per year (weighted) % change"
fout = "../plots/openclose/openclose_cumulative/cumul_openclose_museums_wei_years_pc_change"
plot_cumul_openclose_charts(df,title,fout)
rm(df)

# PLOT cumulative stats just Open museums (WEIGHTED)
df = subset( cumul_years_pc, cumul_years_pc$var_name == 'all' )[,c("year","cumul_open_wei_N")]
df = melt(df,id.vars = c("year"))
names(df)
title = "Cumulative opened museums per year (weighted) % change"
fout = "../plots/openclose/openclose_cumulative/cumul_open_museums_wei_years_pc_change"
plot_cumul_openclose_charts(df,title,fout)
rm(df)

# PLOT cumulative stats just Open museums (WEIGHTED) by country
df = subset( cumul_years_pc, cumul_years_pc$var_name == 'country_gss' )[,c("year","var_value","cumul_open_wei_N")]
colnames(df) = c("year","variable","value")
df$variable = replace_gss_codes(df$variable)
#df = melt(df,id.vars = c("year"))
names(df)
title = "Cumulative opened museums per year (weighted) % change by country"
fout = "../plots/openclose/openclose_cumulative/cumul_open_museums_years_country_pc_change"
plot_cumul_openclose_charts(df,title,fout)
rm(df)

# PLOT cumulative stats just Open museums (WEIGHTED) by eng region
df = subset( cumul_years_pc, cumul_years_pc$var_name == 'region_gss' )[,c("year","var_value","cumul_open_wei_N")]
df = df[ grepl('E',df$var_value), ]
colnames(df) = c("year","variable","value")
df$variable = replace_gss_codes(df$variable)
#df = melt(df,id.vars = c("year"))
names(df)
title = "Cumulative opened museums per year (weighted) % change by English region"
fout = "../plots/openclose/openclose_cumulative/cumul_open_museums_years_engreg_pc_change"
plot_cumul_openclose_charts(df,title,fout)
rm(df)

# PLOT cumulative stats just Open museums (WEIGHTED) by eng region (2 facets)
# (SPLIT into TWO for readability)
df = subset( cumul_years_pc, cumul_years_pc$var_name == 'region_gss' )[,c("year","var_value","cumul_open_wei_N")]
df = df[ grepl('E12',df$var_value), ]

colnames(df) = c("year","variable","value")

df$variable = as.character( replace_gss_codes(df$variable) )
df = sort_df(df,'variable')
df$variable = as.factor(df$variable)

df$facet = ifelse( grepl('East Midlands|East of England|London|North East|North West', df$variable), "A", "B")
df$facet = as.factor(df$facet)
summary(df$facet)

names(df)
title = "Cumulative opened museums per year (weighted) % change by English region"
fout = "../plots/openclose/openclose_cumulative/cumul_open_museums_years_engreg_pc_change_facets"
plot_cumul_openclose_charts(df,title,fout,useFacets=T)

rm(df)

# PLOT cumulative stats just Open museums (WEIGHTED) by governance
df = subset( cumul_years_pc, cumul_years_pc$var_name == 'governance_simpl' )[,c("year","var_value","cumul_open_wei_N")]
colnames(df) = c("year","variable","value")
names(df)
title = "Cumulative opened museums per year (weighted) % change by governance"
fout = "../plots/openclose/openclose_cumulative/cumul_open_museums_years_gov_pc_change"
plot_cumul_openclose_charts(df,title,fout)

# extra map for Report (2020)
fout = "../plots/openclose/openclose_cumulative/cumul_open_museums_years_gov_pc_change_nounk"
df = subset(df,df$variable != 'unknown_gov')
plot_cumul_openclose_charts(df,title,fout)
rm(df)

# PLOT cumulative stats just Open museums (WEIGHTED) by mm size
df = subset( cumul_years_pc, cumul_years_pc$var_name == 'size' )[,c("year","var_value","cumul_open_wei_N")]
colnames(df) = c("year","variable","value")
names(df)
title = "Cumulative opened museums per year (weighted) % change by size"
fout = "../plots/openclose/openclose_cumulative/cumul_open_museums_years_size_pc_change"
plot_cumul_openclose_charts(df,title,fout)
rm(df)

rm(cumul_years_pc)
```

### Open/closings growth trends

```{r growth_trends, eval=T}
FUN_clean_folder("../plots/openclose/openclose_growth",
                 exclude_files = c('README.txt','uk_lad_2016_reference_map.pdf'))

generate_1var_from_cumul_years_ = function(cumul_years, lab){
  print(paste("generate_1var_from_cumul_years",lab))
  names(cumul_years)
  stopifnot(nrow(cumul_years)>100)
  
  # compare 1960 with 2022
  df = subset( cumul_years, cumul_years$year==1960 | cumul_years$year==2022)
  unique(df$var_name)
  print(names(df))
  #BROKEN CODE HERE
  # generate 1 var growth for all museums
  dfopen = dcast(df, formula = var_name + var_value ~ year, value.var = "cumul_open_wei_N" )
  #dfopen = dcast(df, formula = var_name + var_value ~ year, value.var = c("cumul_open_wei_N","cumul_closed_wei_N") )
  dfclosed = dcast(df, formula = var_name + var_value ~ year, value.var = "cumul_closed_wei_N" )
  names(dfopen) = c("var_name","var_value","open1960","open2022" )
  names(dfclosed) = c("var_name","var_value","close1960","close2022" )
  #View(dfopen)
  #View(dfclosed)
  
  # join open and closed data
  dfopen$rowid = paste0(dfopen$var_name,dfopen$var_value)
  dfclosed$rowid = paste0(dfclosed$var_name,dfclosed$var_value)
  stopifnot(dfopen$rowid==dfclosed$rowid)
  dfopen$close1960 = dfclosed$close1960
  dfopen$close2022 = dfclosed$close2022
  dfopen$rowid=NULL
  rm(dfclosed)
  
  #View(dfopen)
  dfopen$geo_label = replace_gss_codes_with_NAs(dfopen$var_value)
  dfopen = dfopen[,c("var_name","var_value","geo_label","open1960","open2022",'close1960','close2022')]
  dfopen$diffN = dfopen$open2022 - dfopen$open1960
  dfopen$growth = ifelse( dfopen$open1960 >= 1, 
        round((dfopen$open2022 - dfopen$open1960) / dfopen$open1960 * 100,1), 
        NA )
  dfopen$open2022 = round(dfopen$open2022,1)
  dfopen$close2022 = round(dfopen$close2022,1)
  dfopen$open1960 = round(dfopen$open1960,1)
  dfopen$close1960 = round(dfopen$close1960,1)
  dfopen$diffN = round(dfopen$diffN,1)
  dfopen$closedpc = ifelse(dfopen$open2022>=1,
        round( dfopen$close2022 / (dfopen$open2022+dfopen$close2022) * 100, 1 ),
        NA)
  return(dfopen)
}

calc_growth_by_two_vars_ = function( musdf, var1, var2 ){
  print(paste('calc_growth_by_two_vars_',nrow(musdf)))
  #View(musdf) # debug
  years = c(1960,2022)
  openm_df = data.frame()
  stopifnot(var2 %in% names(musdf))
  stopifnot(var1 %in% names(musdf))
  stopifnot(nrow(musdf) > 0)
  for (val1 in as.character(unique(musdf[,var1]))){
    print(val1)
    df = musdf[ musdf[ , var1 ]==val1, ]
    for (val2 in as.character(unique(musdf[,var2]))){
      print(paste('   val2',val2))
      # get year 1
      row = get_open_museums_by_year(years[1], df, var2, val2, nonZero = F)
      row$cumul_open_wei_N_min = NULL
      row$cumul_open_wei_N_max = NULL
      row$cumul_closed_wei_N_min = NULL
      row$cumul_closed_wei_N_max = NULL
      row$VAR1 = var1
      row$VAL1 = val1
      #View(row)
      # get year 2
      row2 = get_open_museums_by_year(years[2], df, var2, val2, nonZero = F)
      row2$cumul_open_wei_N_min = NULL
      row2$cumul_open_wei_N_max = NULL
      row2$cumul_closed_wei_N_min = NULL
      row2$cumul_closed_wei_N_max = NULL
      #View(row2)
      row$year = paste0(years,collapse='-')
      row$open2022 = row2$cumul_open_wei_N
      row$close2022 = row2$cumul_closed_wei_N
      #print(names(row))
      stopifnot(ncol(row)==9)
      names(row) = c("year","var2","val2","open1960","close1960",
        "var1","val1","open2022","close2022")
      # calc growth
      row$diffN = row$open2022 - row$open1960
      row$growth = ifelse( row$open1960 >= 1, 
                        round((row$open2022 - row$open1960) / row$open1960 * 100, 1), 
                        NA )
      row$open1960 = round(row$open1960,1)
      row$open2022 = round(row$open2022,1)
      row$diffN = round(row$diffN,1)
      row$closedpc = ifelse(row$open2022>=1,
                        round( row$close2022 / (row$open2022+row$close2022) * 100, 1 ),
                        NA)
      #View(row)
      # save result row
      #print('debug6')
      #print(names(openm_df))
      #print(names(row))
      #print('debug0')
      #row3 = row
      #View(row3)
      openm_df = rbind(openm_df,row)
      #View(openm_df)
      rm(row,row2)
    }
  }
  rm(years)
  rm(df,var1,var2)
  #print(names(openm_df))
  stopifnot(ncol(openm_df)==12)
  openm_df$var1_geo_label = replace_gss_codes_with_NAs(openm_df$val1)
  openm_df = openm_df[,c("year","var1","val1",'var1_geo_label',"var2","val2",
                         "open1960","close1960",'open2022','close2022','closedpc',
                         'diffN','growth')]
  return(openm_df)
}

generate2varsCombinations_ = function( indf ){
  print('generate2varsCombinations_')
  #print(names(indf))
  growthtwodf = data.frame()
  for(var1 in c('size','subject_matter_simpl','subject_matter','region_gss',
                'country_gss','lad16_gss')){
  for(var2 in c('subject_matter_simpl','size','governance','governance_simpl',
                'accreditation')){
    if (var1!=var2){
      print(paste('  ',var1,var2))
      df = calc_growth_by_two_vars_( indf, var1, var2 )
      df$VARS = paste(var1, var2, sep='+')
      #print('debug5')
      growthtwodf = rbind( growthtwodf, df )
      rm(df)
  }}}
  #View(growthtwodf)
  return(growthtwodf)
}

# sdf: spatial data with growth columns
# sdf_simpl: same as sdf
# engl_regs: used to draw borders
plot_choro_map_museum_growth_ <- function(sdf, sdf_simpl, label, var_col, outfolder, engl_regs, binning, bin_n = 7){
  print(paste("  plot_choro_map_museum_growth_:",nrow(sdf), label,var_col,binning,bin_n))
  fout = paste0(label,'-',var_col,'-',binning)
  subtit = get_plot_subtitle(paste0(outfolder,fout))
  attribution = tm_credits(subtit, position = c("right","bottom"),alpha=.5)
  
  #col_palette = "YlOrRd" #"YlGnBu", "PuBu"
  border_col = 'white'
  legend_title = paste0(gsub('_',' ',label), '\n', gsub('\\.','\n  ',var_col),'\n[',binning,']')
  
  brk = classIntervals( as.numeric(sdf_simpl@data[,var_col]), style = binning, n = bin_n)$brks
  
  # base choropleth map of the UK
  m <- tmap::tm_shape(sdf_simpl) + # bbox = bbox, , simplify = .25
    tm_fill(var_col, breaks = brk, #n=bin_n, style=binning, palette=col_palette,
          border.alpha=0, auto.palette.mapping = T, title = legend_title) +
    #tm_scale_bar(width=0.1, position=c("right","bottom")) + 
    tm_legend(scale=0.95) + #attribution +
    tmap::tm_shape(engl_regs) + tm_borders(col = border_col, lwd = .4, alpha = 1) +
    tm_layout(frame=FALSE, legend.title.size=.6, legend.text.size=.4, legend.position = c("left","top")) +
    tm_xlab(subtit, size = .3)
  
  # add London inset
  sdf_London = sdf[ grepl('E090', sdf$GSS), ]
  #print( nrow(sdf_London) )
  if(nrow(sdf_London)==33){
    m_London <- tm_shape(sdf_London) + tm_fill(var_col, breaks = brk, #palette=col_palette,
            border.alpha=0, auto.palette.mapping = T, title = NA, legend.show = F) +
            tm_layout( frame = T, frame.lwd = 1 )
    
    vp_London <- viewport(x = 0.8, y = 0.65, width = 0.34, height = 0.34)
    
    tmap_mode("plot")
    m
    print(m_London, vp = vp_London)
    #save_tmap(m, paste0(outfolder, fout,'.png'), width = 4, height = 6)
    tmap_save(m, paste0(outfolder, fout,'.pdf'), width = 4, height = 6, 
            insets_tm = list(m_London), insets_vp = list(vp_London))
  } else {
    #save_tmap(m, paste0(outfolder, fout,'.png'), width = 4, height = 6)
    tmap_save(m, paste0(outfolder, fout,'.pdf'), width = 4, height = 6)
  }
}

# dfopen
# growthtwodf: two var table
# lab: 
gen_growth_maps_ = function(dfopen, growthtwodf, lab, growth_outfold ){
  print('gen_growth_maps_')
  stopifnot( nrow(dfopen)>0 )
  stopifnot( nrow(growthtwodf)>0 )
  
  # used for borders
  engl_regs = load_uk_dataset('eng_regions_2011-simp005.rds')
  engl_regs = rmapshaper::ms_simplify(engl_regs, keep = .05)
  
  # ------ 1 var -------
  #---
  # LADs 2016 maps
  #----
  uk_lads_2016 <- load_uk_dataset("uk_local_auth_2016-simp01.rds")
  uk_lads_2016_growth = merge( uk_lads_2016, dfopen, by.x="GSS", by.y="var_value", all.y=F)
  names(uk_lads_2016_growth)
  # "GSS" "NAME" "var_name" "geo_label" "open1960"  "open2022"  "diffN" "growth"
  
  #uk_lads_2016_simpl = rmapshaper::ms_simplify(uk_lads_2016, keep = .02)
  #names(uk_lads_2016) = make.names(names(uk_lads_2016))
  #names(uk_lads_2016_simpl) = make.names(names(uk_lads_2016_simpl))
  #stopifnot(nrow(uk_lads_2016_simpl)==nrow(uk_lads_2016))
  
  VARS_GROWTH = c('growth','diffN','open1960','open2022','close2022','closedpc')
  
  for(f in VARS_GROWTH){
    for(q in c('jenks')) # 'quantile','equal',
    plot_choro_map_museum_growth_( uk_lads_2016_growth, uk_lads_2016_growth, 
              paste0(lab,'-growth_map-LAD2016'), f, growth_outfold, engl_regs, q )
  }
  rm(f,q)
  
  rm(uk_lads_2016_growth)
  #rm(uk_lads_2016)
  
  # ----
  # English Region + Countries maps
  # ----
  #   all museums
  uk_countries_regs11 = load_uk_dataset("uk_countries_and_eng_regions_2011-simp001.rds")
  uk_countries_regs11_growth = merge( uk_countries_regs11, 
                                      subset(dfopen, dfopen$var_name == 'region_gss'), 
                                      by.x="GSS", by.y="var_value", all.y=F)
  #View(uk_countries_regs11_growth)
  
  for(f in VARS_GROWTH){
    for(q in c('jenks')) # 'quantile','equal',
    plot_choro_map_museum_growth_( uk_countries_regs11_growth, uk_countries_regs11_growth, 
            paste0(lab,'-mapgrowth-countries_engregs'),f, growth_outfold, engl_regs, q )
  }
  rm(f,q,uk_countries_regs11_growth)
  # ---
  # Eng Regions+LADs by vars
  # ---
  print('Gen maps Eng Regions+LADs by vars ')
  GEOVARS = c('region_gss','lad16_gss')
  SUBVARS = c('size','governance_simpl','subject_matter_simpl')
  for(g in GEOVARS){
  for(v in SUBVARS){
    if (g == 'region_gss') geo_sdf=uk_countries_regs11 else geo_sdf=uk_lads_2016
    # lab, growthtwodf, geo_sdf, geovar, var_name, growth_outfold, engl_regs
    plot_choro_map_museum_growth_by_var_(lab, growthtwodf, geo_sdf, g, v, growth_outfold, engl_regs)
  }}
  rm(geo_sdf,uk_lads_2016)
}

# plot growth maps with a secondary variable (var_name)
# @lab: all, indep or lauth
# @geovar: 
plot_choro_map_museum_growth_by_var_ = function( lab, growthtwodf, geo_sdf, geovar, var_name, growth_outfold, engl_regs ){
  print(paste("  plot_choro_map_museum_growth__by_var:", lab, nrow(growthtwodf), nrow(geo_sdf), var_name, geovar))
  subgrowthtwodf = subset(growthtwodf, growthtwodf$var1 == geovar & growthtwodf$var2 == var_name)
  stopifnot(nrow(subgrowthtwodf)>0)
  if (nrow(subgrowthtwodf)==0){
    print("  no data found")
    return(NA)
  }
  
  suboutfold = paste0(growth_outfold, 'growth_by_',var_name, '/')
  dir.create(suboutfold, showWarnings = F)
  print(suboutfold)
  
  stopifnot(nrow(subgrowthtwodf)>0)
  #print(names(dfopen))
  for (val in unique(subgrowthtwodf$val2)){
    label = paste(var_name,"=",val)
    print(label)
    #View(dfopen)
    df = subset( subgrowthtwodf, subgrowthtwodf$val2 == val )
    stopifnot(nrow(df)>0)
    geo_growth = merge( geo_sdf, df, by.x="GSS", by.y="val1", all.y=F)
    
    for(f in c('growth','diffN','open2022','close2022')){  # ,'open1960','')){
      for(q in c('jenks')){ # 'quantile','equal',{
        if (FUN_countNotNA(unique(geo_growth@data[,f]))<2){
          print(paste("Not enough values for ",label,' - skipping map'))
          next()
        }
        plot_choro_map_museum_growth_( geo_growth, geo_growth, 
                                      paste0(lab,'-growth_map-',geovar,'_by_',var_name,"_", val), 
                                      f, suboutfold, engl_regs, q )
      }
    }
    rm(geo_growth)
  }
  rm(f,q,geo_growth,suboutfold)
}

generate_all_growth_stats = function(cumul_years, lab, mdf){
  # outfolder
  growth_outfold = paste0('../plots/openclose/openclose_growth/growth_',lab,'/')
  dir.create(growth_outfold, showWarnings = T)
  stopifnot(file.exists(growth_outfold))
  print(growth_outfold)
  
  # gen 1 var stats
  dfopen = generate_1var_from_cumul_years_(cumul_years, lab)
  write_xlsx(dfopen, paste0(growth_outfold,'openclose_1960_2022_pc_change-1vars-',lab,'.xlsx'))
  
  foutn = paste0(growth_outfold,'openclose_1960_2022_pc_change-2vars-',lab,'.xlsx')
  if (T){
    # gen 2 vars stats
    growthtwo_df = generate2varsCombinations_(mdf)
    write_xlsx(growthtwo_df, foutn)
  }
  if (T){
    # gen maps
    growthtwo_df = read_excel(foutn)
    gen_growth_maps_(dfopen, growthtwo_df, lab, growth_outfold)
  }
}
```

Run growth stats

```{r}
mdf = museums_bg

# generate all growth stats
mdfindip = subset(mdf@data, mdf@data$governance_simpl == 'independent')
nrow(mdfindip)
mdflauth = subset(mdf@data, mdf@data$governance == 'Government-Local_Authority')
nrow(mdflauth)

# load cumulative stats
cumul_years3 = read_excel('../plots/openclose/openclose_cumulative/years_openclose_stats_cumulative-mus_all.xlsx')
cumul_years_indep3 = read_excel('../plots/openclose/openclose_cumulative/years_openclose_stats_cumulative-mus_indep.xlsx')
cumul_years_lauth3 = read_excel('../plots/openclose/openclose_cumulative/years_openclose_stats_cumulative-mus_lauth.xlsx')

# gen stats (SLOW)
generate_all_growth_stats(cumul_years3, 'mus_all', mdf@data)
generate_all_growth_stats(cumul_years_indep3, 'mus_indep', mdfindip)
generate_all_growth_stats(cumul_years_lauth3, 'mus_lauth', mdflauth)
rm(mdfindip,mdflauth)

#rm(engl_regs)
rm(dfopen)
rm(mdf)
# ------------------------------------------------------------------------------
```

### Open/closings by govern/size/class 

```{r closing_analysis_gov, eval=T}

# prep gov data
years_df = read_excel('../plots/openclose/openclose_years/years_openclose_stats.xlsx')
names(years_df)
measure_vars = names(years_df)[grepl("open_gov_wei",names(years_df))]
years_exp_df = reshape2::melt(years_df, measure.vars=measure_vars)
rm(measure_vars)
# PLOT: openings by governance (all types)
plot_openings_closings(years_exp_df,"Museum Openings by Simpl Governance: weighted values per year",'../plots/openclose/openclose_years/open_govern_year')
rm(years_exp_df)

# PLOT: closings by governance (all types)
measure_vars = names(years_df)[grepl("close_gov_wei",names(years_df))]
years_exp_df = reshape2::melt(years_df,measure.vars=measure_vars)
plot_openings_closings(years_exp_df,"Museum Closings by Simpl Governance: weighted values per year",'../plots/openclose/openclose_years/close_govern_year')
rm(measure_vars)
rm(years_exp_df)

# RATIO of closings / open museums by governance
measure_vars = names(years_df)[grepl("close_gov_wei",names(years_df))]
years_exp_df = reshape2::melt(years_df,measure.vars=measure_vars)[,c("year","variable","value")]
names(years_exp_df)
# take cumulative data
cum_years = subset(cumul_years,cumul_years$var_name == 'governance_simpl' )[,c("year","var_value","cumul_open_wei_N")]
colnames(cum_years) = c("year","variable","value")

years_exp_df$variable = gsub("close_gov_wei-","",years_exp_df$variable)
stopifnot(nrow(years_exp_df)==nrow(cum_years))
mm = merge(cum_years,years_exp_df,by=c("year","variable"))
colnames(mm) = c("year","variable","cumul_open","closings")
nrow(mm)
mm$percent_closed = round( (mm$closings / mm$cumul_open)*100,3)

write_xlsx(mm, "../plots/openclose/openclose_years/years_openclose_proportion_stats.xlsx")

mm_df = mm[,c("year","variable","percent_closed")]
colnames(mm_df) = c("year","variable","value")

# filter unknown gov out

plot_openings_closings(mm_df,"Percentage of Museum Closings by Simpl Governance",'../plots/openclose/openclose_years/close_govern_year_proportion')

# extra plot without UKNOWN gov for Jamie (2018)
#mm_df = subset(mm_df,mm_df$variable != 'unknown_gov')
mm_df = subset(mm_df,mm_df$variable %in% c('state','independent'))

# plot SMOOTHED
p = ggplot(mm_df, aes(year, value, group=variable, color=variable )) + # linetype=variable
  #geom_line() + geom_point(size=1) +
    #stat_smooth(inherit.aes = T, fullrange = T) +
    #stat_smooth(method = "loess", formula = y ~ x, size = 1) +
    geom_smooth( span = .25, se = F ) +  # SMOOTHING FUNCTION
    ggtitle(paste0("Percentage of Museum Closings by Simpl Governance [smoothed]"),
            subtitle = get_plot_subtitle('../plots/openclose/openclose_years/close_govern_year_proportion-smoothed2.pdf')) +
    xlab("Year") + ylab("% of museums") +
    geom_hline(yintercept = 0,alpha=.5) +
    ylim(0,1.2) +
    scale_x_continuous(breaks = seq(min(years_df$year), max(years_df$year),5)) +
    theme_light() +  theme(panel.grid.minor.x = element_line(colour = "gray"),
     panel.grid.major.x = element_line(colour = "darkgray"))
ggsave('../plots/openclose/openclose_years/close_govern_year_proportion-smoothed2.pdf',p,width = 8,height = 5)

p = ggplot(mm_df, aes(year, value, group=variable, color=variable )) + # linetype=variable
    geom_line() + geom_point(size=1) +
    #stat_smooth(inherit.aes = T, fullrange = T) +
    #stat_smooth(method = "loess", formula = y ~ x, size = 1) +
    #geom_smooth( span = .25, se = F ) +  # SMOOTHING FUNCTION
    ggtitle(paste0("Percentage of Museum Closings by Simpl Governance"),
            subtitle = get_plot_subtitle('../plots/openclose/openclose_years/close_govern_year_proportion-full2.pdf')) +
    xlab("Year") + ylab("% of museums") +
    geom_hline(yintercept = 0,alpha=.5) +
    ylim(0,2.6) +
    scale_x_continuous(breaks = seq(min(years_df$year), max(years_df$year),5)) +
    theme_light() +  theme(panel.grid.minor.x = element_line(colour = "gray"),
     panel.grid.major.x = element_line(colour = "darkgray"))
ggsave('../plots/openclose/openclose_years/close_govern_year_proportion-full2.pdf',p,width = 8,height = 5)

rm(p,years_exp_df)
rm(cum_years,mm_df)
#View(cum_years)
#View(cumul_years)
#View(years_exp_df)

### Open/closings by size

# prep sz data
names(years_df)
years_exp_df = reshape2::melt(years_df,
                        measure.vars=c("open_size_wei-small","open_size_wei-medium",
                                       "open_size_wei-large","open_size_wei-unknown_sz"))

# PLOT: openings by size (all types)
plot_openings_closings(years_exp_df,"Museum Openings by Simpl Size: weighted values per year",'../plots/openclose/openclose_years/open_size_year')

# prep Closing by Size data
years_exp_df = reshape2::melt(years_df,
                        measure.vars=c("close_size_wei-small","close_size_wei-medium",
                                       "close_size_wei-large","close_size_wei-unknown_sz"))

plot_openings_closings(years_exp_df,"Museum Closings by Simpl Size: weighted values per year",'../plots/openclose/openclose_years/close_size_year')

### Open/closings by classification 2018

#summary(mdf$subject_matter_simpl_aggr)

# prep classif data for openings
# too many lines
if (F){
  names(years_df)
  years_exp_df = reshape2::melt(years_df,
                          measure.vars=paste0("open_subjmatt_wei-",class18_simpl_aggr_types))
  plot_openings_closings(years_exp_df,"Museum Openings by Simpl Subject Matter: weighted values per year",'../plots/openclose/openclose_years/open_subjmatt_year')
  
  years_exp_df = reshape2::melt(years_df,
                          measure.vars=paste0("close_subjmatt_wei-",class18_simpl_aggr_types))
  plot_openings_closings(years_exp_df,"Museum Closings by Simpl Subject Matter: weighted values per year",'../plots/openclose/openclose_years/close_subjmatt_year')
}
rm(mdf)
```

### Open/closings by decade

```{r closing_analysis_decade, eval=T}

# clean up out folder
FUN_clean_folder("../plots/openclose/openclose_decades/")
names(years_df)

plot_decade_stats <- function(df,title,outf,ylabel = 'events'){
  print("plot_decade_stats")
  width_sz = 9
  height_sz = 7
  g = ggplot(data=df, aes(x=decade, y=value, fill=variable)) +
    geom_bar(stat="identity",position=position_dodge(), colour = 'white') + theme_light()  +
    #geom_bar(stat="identity", position=position_dodge()) + theme_light()  +
    #scale_fill_manual(values=c('darkgreen','red')) +
    xlab("Decade") + ylab(paste("Number of",ylabel)) +
    ggtitle(paste0(title), subtitle = get_plot_subtitle(outf))
    #labs(caption = "H. Wickham. ggplot2: Elegant Graphics for Data Analysis Springer-Verlag New York, 2009.")

  ggsave(plot = g,filename = paste0(outf,'.png'),width=width_sz,height = height_sz)
  ggsave(plot = g,filename = paste0(outf,'.pdf'),width=width_sz,height = height_sz)

  g = ggplot(data=df, aes(x=decade, y=value, fill=variable)) +
    geom_bar(stat="identity",position='stack', colour = 'white')+ theme_light()  +
    #geom_bar(stat="identity", position=position_dodge()) + theme_light()  +
    #scale_fill_manual(values=c('darkgreen','red')) +
    xlab("Decade") + ylab(paste("Number of",ylabel)) +
  ggtitle(paste0(title," [stack]"), subtitle = get_plot_subtitle(outf,"-stack"))
  ggsave(plot = g,filename = paste0(outf,'-stack.png'),width=width_sz,height = height_sz)
  ggsave(plot = g,filename = paste0(outf,'-stack.pdf'),width=width_sz,height = height_sz)

  g = ggplot(data=df, aes(x=decade, y=value, fill=variable)) +
    geom_bar(stat="identity",position='fill', colour = 'white')+ theme_light()  +
    #geom_bar(stat="identity", position=position_dodge()) + theme_light()  +
    #scale_fill_manual(values=c('darkgreen','red')) +
    scale_y_continuous(labels = percent_format()) +
    xlab("Decade") + ylab(paste("% of",ylabel)) +
    ggtitle(paste0(title," [percent]"), subtitle = get_plot_subtitle(outf,"-percent"))
  ggsave(plot = g,filename = paste0(outf,'-percent.png'),width=width_sz,height = height_sz)
  ggsave(plot = g,filename = paste0(outf,'-percent.pdf'),width=width_sz,height = height_sz)

  rm(g)
}

# aggregate year stats data by decade
openclose_df_decades = aggregate(.~decade, data=years_df, sum )

# remove invalid cols
openclose_df_decades = openclose_df_decades[-c(ncol(openclose_df_decades),2,3)]
openclose_df_decades$closing_N = NA

# add 's' to decade name
openclose_df_decades$decade = as.factor(paste0(as.character(openclose_df_decades$decade),"s"))

write_xlsx(openclose_df_decades,"../plots/openclose/openclose_decades/decades_openclose_stats.xlsx")

# plot open close by decade
decades = openclose_df_decades[,c("decade","opening_wei_N","closing_wei_N")]
decades = melt(decades)
#View(decades)

g = ggplot(data=decades, aes(x=decade, y=value, fill=variable)) +
  geom_bar(stat="identity", position=position_dodge(), alpha=.9, color='white') + theme_light()+ xlab("Decade") +
  ylab("Number of openings/closings") +
  scale_fill_manual(values=c('palegreen4','lightcoral')) +
  ggtitle("Openings and closings by decade (weighted number of museums)")

ggsave(plot = g,filename = '../plots/openclose/openclose_decades/openclose_decade.png')
ggsave(plot = g,filename = '../plots/openclose/openclose_decades/openclose_decade.pdf')
rm(decades)

# -----------PLOT open close by decade and size -----------
decades = openclose_df_decades[,c("decade",names(openclose_df_decades)[ grepl("open_size_",names(openclose_df_decades)) ])]
decades = melt(decades)

plot_decade_stats(decades,"Openings by size by decade (weight. museum no.)",
                  "../plots/openclose/openclose_decades/decade_open_by_size",ylabel='openings')

decades = openclose_df_decades[,c("decade",names(openclose_df_decades)[ grepl("close_size_",names(openclose_df_decades)) ])]
decades = melt(decades)

plot_decade_stats(decades,"Closings by size by decade (weight. museum no.)",
                  "../plots/openclose/openclose_decades/decade_close_by_size",ylabel='closings')

# -----------PLOT open close by decade and accreditation -----------
decades = openclose_df_decades[,c("decade",names(openclose_df_decades)[ grepl("open_accr_",names(openclose_df_decades)) ])]
decades = melt(decades)

plot_decade_stats(decades,"Openings by accreditation by decade (weight. museum no.)",
                  "../plots/openclose/openclose_decades/decade_open_by_accreditation",ylabel='openings')

decades = openclose_df_decades[,c("decade",names(openclose_df_decades)[ grepl("close_accr_",names(openclose_df_decades)) ])]
decades = melt(decades)

plot_decade_stats(decades,"Closings by accreditation by decade (weight. museum no.)",
                  "../plots/openclose/openclose_decades/decade_close_by_accreditation",ylabel='closings')


# ----------- PLOT open close by decade and gov -----------
decades = openclose_df_decades[,c("decade",names(openclose_df_decades)[ grepl("open_gov_",names(openclose_df_decades)) ])]
decades = melt(decades)

plot_decade_stats(decades,"Openings by governance by decade (weight. museum no.)",
                  "../plots/openclose/openclose_decades/decade_open_by_govern",ylabel='openings')


decades = openclose_df_decades[,c("decade",names(openclose_df_decades)[ grepl("close_gov_",names(openclose_df_decades)) ])]
decades = melt(decades)

plot_decade_stats(decades,"Closings by governance by decade (weight. museum no.)",
                  "../plots/openclose/openclose_decades/decade_close_by_govern",ylabel='closings')

# ----------- PLOT open close by decade and gov -----------
decades = openclose_df_decades[,c("decade",names(openclose_df_decades)[ grepl("open_accr_",names(openclose_df_decades)) ])]
decades = melt(decades)

plot_decade_stats(decades,"Openings by governance by decade (weight. museum no.)",
                  "../plots/openclose/openclose_decades/decade_open_by_govern",ylabel='openings')


decades = openclose_df_decades[,c("decade",names(openclose_df_decades)[ grepl("close_gov_",names(openclose_df_decades)) ])]
decades = melt(decades)

plot_decade_stats(decades,"Closings by governance by decade (weight. museum no.)",
                  "../plots/openclose/openclose_decades/decade_close_by_govern",ylabel='closings')

#  -----------PLOT open close by country -----------
decades = openclose_df_decades[,c("decade",names(openclose_df_decades)[ grepl("open_country_",names(openclose_df_decades)) ])]
decades = melt(decades)
decades$variable = replace_gss_codes_split(decades$variable)

plot_decade_stats(decades,"Openings by decade in UK country (weight. museum no.)",
                  "../plots/openclose/openclose_decades/decade_open_by_country",ylabel='openings')

decades = openclose_df_decades[,c("decade",names(openclose_df_decades)[ grepl("close_country_",names(openclose_df_decades)) ])]
decades = melt(decades)
decades$variable = replace_gss_codes_split(decades$variable)

plot_decade_stats(decades,"Closings by decade in UK country (weight. museum no.)",
                  "../plots/openclose/openclose_decades/decade_close_by_country",ylabel='closings')


#  -----------PLOT open close by region -----------
decades = openclose_df_decades[,c("decade",names(openclose_df_decades)[ grepl("open_reg_",names(openclose_df_decades)) ])]
decades = melt(decades)
decades$variable = replace_gss_codes_split(decades$variable)

plot_decade_stats(decades,"Openings by decade in country/region (weight. museum no.)",
                  "../plots/openclose/openclose_decades/decade_open_by_region",ylabel='openings')

decades = openclose_df_decades[,c("decade",names(openclose_df_decades)[ grepl("close_reg_",names(openclose_df_decades)) ])]
decades = melt(decades)
decades$variable = replace_gss_codes_split(decades$variable)

plot_decade_stats(decades,"Closings by decade in country/region (weight. museum no.)",
                  "../plots/openclose/openclose_decades/decade_close_by_region",ylabel='closings')

rm(decades,g)
```

### Open/closings by country/region

```{r closing_analysis_regions, eval=T}

FUN_clean_folder("../plots/openclose/openclose_geo/")

nrow(museums_bg)
# openings years by COUNTRY
reg_cols = sort(names(years_df)[grepl( "open_country_wei-", names(years_df) )])
years_exp_df = reshape2::melt(years_df,
                        measure.vars=reg_cols)
years_exp_df$variable = replace_gss_codes_split(years_exp_df$variable)
#summary(test)
#View(years_exp_df)
plot_openings_closings(years_exp_df,"Museum Openings by Country: weighted values per year",
                       '../plots/openclose/openclose_geo/open_country_year')

# closing years by COUNTRY
reg_cols = sort(names(years_df)[grepl( "close_country_wei-", names(years_df) )])
years_exp_df = reshape2::melt(years_df,
                        measure.vars=reg_cols)
years_exp_df$variable = replace_gss_codes_split(years_exp_df$variable)
plot_openings_closings(years_exp_df,"Museum Closings by Country: weighted values per year",
                       '../plots/openclose/openclose_geo/close_country_year')

# openings years by REGIONS
reg_cols = sort(names(years_df)[grepl( "open_reg_wei-", names(years_df) )])
years_exp_df = reshape2::melt(years_df,
                        measure.vars=reg_cols)
years_exp_df$variable = replace_gss_codes_split(years_exp_df$variable)
plot_openings_closings(years_exp_df,"Museum Openings by Country and Region: weighted values per year",'../plots/openclose/openclose_geo/open_region_year')

# closing years by REGIONS
reg_cols = sort(names(years_df)[grepl( "close_reg_wei-", names(years_df) )])
years_exp_df = reshape2::melt(years_df,
                        measure.vars=reg_cols)
years_exp_df$variable = replace_gss_codes_split(years_exp_df$variable)
plot_openings_closings(years_exp_df,"Museum Closings by Country and Region: weighted values per year",'../plots/openclose/openclose_geo/close_region_year')

reg_cols = c("year",sort(names(years_df)[grepl( "_reg_", names(years_df) )]))
write_xlsx(years_df[,reg_cols],'../plots/openclose/openclose_geo/year_openclose_regions_stats.xlsx')

reg_cols = c("year",sort(names(years_df)[grepl( "_country_", names(years_df) )]))
write_xlsx(years_df[,reg_cols],'../plots/openclose/openclose_geo/year_openclose_country_stats.xlsx')

```

### Open/closing animated maps

Animation maps.

```{r closings_maps, eval=FALSE}

outfold = '../plots/maps/openclose_maps/'
FUN_clean_folder(outfold)

check_mm_valid(museums_bg)

gen_animated_map = function( outfold, all_museums, years, col_field, delay=100 ){
  museumBboxBg <- bbox(all_museums)
  
  # generate a map for each year
  yimages = FUN_foreach_in( years, function(y){
    print(y)
    dot_col = 'steelblue3'
    # get museums open in year y
    df = all_museums
    df$open_prob = FUN_get_open_at_given_time(df@data, y)
    #print(summary(df$open_prob))
    #summary(df$open_prob)
    #print(nrow(museums_y))
    
    fn = paste0(outfold,'maps-singleyear-',y,'.png')
    
    # min threshold
    MIN_OPEN_PROB = .8
    dfopen = subset(df, df$open_prob >= MIN_OPEN_PROB)
    #print(paste(' ',nrow(dfopen)))
    
    stopifnot(nrow(uk_countries_reg_2011_simpl_bg)>0)
    stopifnot(nrow(dfopen)>0)
    
    if (is.na(col_field)) col_field = 'steelblue3'
    
    dot_map <- tmap::tm_shape(uk_countries_reg_2011_simpl_bg, simplify = .5, bbox = museumBboxBg) +
      tm_polygons(col='gray95', border.col = 'white', lwd=1.5) +
      #tm_borders(col = 'white', lwd = .3, alpha = 1) +
      tmap::tm_shape(dfopen) +
      tmap::tm_symbols( col=col_field, style='cat', palette="Set1", size=.03, alpha=.3, border.lwd=NA ) +
      #tm_shape(get_cities_for_labels(80000)) + # load cities
      #tm_text("name", col = "gray", size = .2, alpha = .7, auto.placement = F) + # city labels
      tmap::tm_credits(" Mapping Museums, 2019 (Birkbeck, University of London)\nFiona Candlin, Alex Poulovassilis, Andrea Ballatore et al.",
                       size = .6, col = 'gray65', position = c(NA,-.005)) + 
      #tm_legend(scale=0.75, title=NA, position=c("right","top")) +
         # , bg.color = "white", bg.alpha=.2,
      tm_layout(frame=F, title = paste0('Museums in the UK\n(',y,')'),
                title.color = 'gray50', title.size = 1.1,
                legend.outside = F,
                legend.position = c(.7,.7),
                legend.title.size = 0.0001,
                legend.text.size = 0.6, legend.text.color = 'gray50')
    tmap::tmap_save(dot_map, fn, width = 3, height = 6)
    #print(paste(' ',fn))
    rm(dfopen)
    return(fn)
  })
  
  # join images into an animated gif
  yy = paste0(min(years),'_',max(years))
  res_fn = paste0(outfold, 'museum_opened_animation-',yy,'-',col_field,'.gif')
  yimages = yimages[,1]
  cmd = paste("convert -delay", delay, paste0(outfold,'maps-singleyear-*.png'), res_fn)
  print(cmd)
  system(cmd)
  #frames = image_read(yimages)
  #animation <- image_animate(frames, fps = 2)
  #image_write(animation, res_fn)
  
  # done
  print(res_fn)
  unlink(paste0(outfold,'maps-singleyear-*.png'))
}

for (v in c(NA,'governance_simpl','size')){
  gen_animated_map(outfold, museums_bg, seq(1880,2020,1), v,  delay=13  )
  gen_animated_map(outfold, museums_bg, seq(1960,2018,1), v,  delay=45 )  
}

#gen_animated_map(outfold, museums_bg, seq(1960,2018,1), 'governance_simpl')
#gen_animated_map(outfold, museums_bg, seq(1960,2018,1), 'size')

rm(outfold)
```

### Temporal uncertainty

- calculate bounds for number of open museums (min/max); 
- calculate curve of time intervals (density, from 0 to 60 years) from FUN_get_openings_over_time

```{r, eval=FALSE}
outdir = '../plots/openclose/openclose_uncertainty/'
FUN_clean_folder(outdir)

# ------------------------------------------------------------------------------
# Length of intervals
# ------------------------------------------------------------------------------
# prep data
df = museums_bg
df$year_opened_len = df$year_opened_END - df$year_opened_BEG
stopifnot(df$year_opened_len>=0)
df$year_closed_len = df$year_closed_END - df$year_closed_BEG
#stopifnot(df$year_closed_len>=0)
df@data[,c('year_closed_BEG','year_closed_END','year_closed_len')]


gen_hist_table = function(x, breaks, fn){
  res = hist(x,breaks = breaks,plot = F)
  histdf = data.frame( x_min = res$breaks, x_max = lead(res$breaks), counts = c(res$counts,NA) )
  histdf$counts_pc = round(histdf$counts / sum(histdf$counts,na.rm = T) * 100,2)
  write_xlsx(histdf,fn)
  rm(res)
}

# plots
pdf(paste0(outdir,'opening_intervals_plots.pdf'))

ggplot(df@data, aes(x=year_opened_len)) + geom_histogram() + theme_light()

gen_hist_table(df$year_opened_len, c(0,1,10,20,30,40,50,60,100),
               paste0(outdir,'opening_interval_hist.xlsx'))

closdf = data.frame( closl = df$year_closed_len[!is.na(df$year_closed_len)] )

ggplot(closdf, aes(closl)) + geom_histogram() + theme_light()

gen_hist_table(closdf$closl, c(0,1,10,20,30,40,50,60,100),
               paste0(outdir,'closing_interval_hist.xlsx'))
dev.off()

# ------------------------------------------------------------------------------
# Opening with intervals
# ------------------------------------------------------------------------------


rm(df)
```
